<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMU Ground Station</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js for Real-time Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js plugins for advanced features -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- Cesium for 3D visualization -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <!-- Fallback Cesium CDN -->
    <script>
        // Fallback if primary Cesium fails to load
        if (typeof Cesium === 'undefined') {
            console.log('Primary Cesium failed, trying CDN fallback...');
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/cesium@1.111.0/Build/Cesium/Cesium.js';
            script.onerror = function() {
                console.error('Cesium CDN fallback also failed');
                document.addEventListener('DOMContentLoaded', function() {
                    const container = document.getElementById('cesiumContainer');
                    if (container) {
                        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">3D visualization unavailable. Please check your internet connection.</div>';
                    }
                });
            };
            document.head.appendChild(script);
        }
    </script>
    <!-- Web Audio API for spectrogram -->
    <script src="https://cdn.jsdelivr.net/npm/fft-js@0.0.12/src/fft.js"></script>
    <!-- jQuery for Flight Indicators -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Flight Indicators JavaScript -->
    <script src="{{ url_for('static', filename='js/jquery.flightindicators.js') }}"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Flight Indicators CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/flightindicators.css') }}" />
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --border-color: #dee2e6;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 8px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            color: var(--primary-color);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Professional Header */
        .header {
            background: white;
            border-bottom: 3px solid var(--secondary-color);
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 15px;
            font-size: 28px;
            font-weight: 600;
        }

        /* Enhanced Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .status-test-data {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        .status-real-data {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }

        /* Professional Status Indicators */
        .status-indicator i {
            font-size: 16px;
        }

        .status-indicator.pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Tabbed Interface */
        .tab-container {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tab-header {
            display: flex;
            background: var(--light-bg);
            border-bottom: 2px solid var(--border-color);
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-color);
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .tab-button.active {
            background: white;
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* Professional Panels */
        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary-color);
        }

        .panel h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel h3 i {
            color: var(--secondary-color);
        }

        /* Connection Panel */
        .connection-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--info-color);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--primary-color);
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        /* Professional Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-1px);
        }

        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .data-item {
            text-align: center;
            padding: 15px;
            background: var(--light-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .data-item .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-item .value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Flight Instruments */
        .flight-instruments {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .flight-instruments h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .instruments-grid-2x3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .instrument-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        /* Map Container */
        .map-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        #map {
            height: 400px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        /* Charts */
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .chart-container canvas {
            max-height: 300px;
        }

        /* Advanced Charts Styles */
        .chart-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .chart-btn {
            padding: 8px 16px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .chart-btn:hover {
            background: var(--primary-color);
        }

        .chart-btn.active {
            background: var(--success-color);
        }

        /* Spectrogram Styles */
        .spectrogram-container {
            background: #000;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .spectrogram-container canvas {
            border-radius: 4px;
        }

        .spectrogram-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .spectrogram-btn {
            padding: 8px 16px;
            background: var(--warning-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .spectrogram-btn:hover {
            background: var(--danger-color);
        }

        .spectrogram-btn.active {
            background: var(--success-color);
        }

        #spectrogramSource {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
        }

        /* Log Analysis Styles */
        .log-analysis-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .log-btn {
            padding: 10px 20px;
            background: var(--info-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .log-btn:hover {
            background: var(--primary-color);
        }

        #logFileInput {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
        }

        .log-analysis-results {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .analysis-chart {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
        }

        .analysis-stats {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
        }

        .analysis-stats h4 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        /* Cesium 3D Visualization Styles */
        .cesium-container {
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }

        .cesium-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .cesium-btn {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .cesium-btn:hover {
            background: var(--secondary-color);
        }

        .cesium-btn.active {
            background: var(--success-color);
        }

        /* Responsive Design for Advanced Features */
        @media (max-width: 768px) {
            .log-analysis-results {
                grid-template-columns: 1fr;
            }
            
            .chart-controls,
            .spectrogram-controls,
            .cesium-controls {
                justify-content: center;
            }
            
            .cesium-container {
                height: 400px;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }

            .header {
                padding: 10px 15px;
            }

            .header h1 {
                font-size: 24px;
            }

            .status-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .tab-header {
                flex-direction: column;
            }

            .tab-button {
                border-bottom: 1px solid var(--border-color);
                border-right: none;
            }

            .tab-button.active {
                border-bottom-color: var(--secondary-color);
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .data-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .instruments-grid-2x3 {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(3, 1fr);
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
        }

        @media (max-width: 480px) {
            .data-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .data-item .value {
                font-size: 16px;
            }

            .instruments-grid-2x3 {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(6, 1fr);
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--secondary-color);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-bg);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }
        
        .data-card {
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .data-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .data-value {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .data-unit {
            font-size: 12px;
            color: #6c757d;
        }

        .map-container {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .logging-controls {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logging-controls h4 {
            margin: 0 0 10px 0;
            color: #fff;
            font-size: 14px;
        }
        
        .logging-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .logging-buttons .btn {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .logging-status {
            font-size: 12px;
            color: #ccc;
        }
        
        .logging-status span {
            display: block;
            margin-bottom: 2px;
                }
        
        /* Switch Status Styles */
        .switch-status {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .switch-label {
            font-weight: bold;
            color: #856404;
            margin-right: 10px;
        }
        
        .switch-value {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            background: #fff3cd;
            color: #856404;
        }
        
        .switch-value.ready {
            background: #d4edda;
            color: #155724;
        }
        
        .switch-value.not-ready {
            background: #f8d7da;
            color: #721c24;
        }
        
        .switch-note {
            margin-top: 10px;
            font-size: 14px;
            color: #856404;
            line-height: 1.4;
        }
        
        .pid-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .pid-layout {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .pid-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e1e8ed;
        }
        
        .pid-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
        }
        
        .pid-middle {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .copy-btn {
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
            background: #6c757d;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .copy-btn:hover {
            background: #5a6268;
        }
        
        .pid-group {
            margin-bottom: 15px;
        }
        
        .pid-group h5 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .pid-row {
            display: grid;
            grid-template-columns: 60px 60px 60px 60px auto;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .pid-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .pid-row input {
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            width: 50px;
            max-width: 60px;
        }
        
        .pid-row input[readonly] {
            background: #e9ecef;
            color: #495057;
        }
        
        .pid-row .btn {
            padding: 6px 12px;
            font-size: 11px;
        }
        
        .request-all {
            text-align: center;
            margin-top: 15px;
        }
        
        .request-all .btn {
            padding: 10px 20px;
            font-size: 14px;
        }
        
        .pid-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #e1e8ed;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #495057;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin: 0;
        }
        
        .note {
            font-size: 12px;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .note-icon {
            color: #dc3545;
            font-weight: bold;
        }

        /* Responsive Design for PID Panel */
        @media (max-width: 1200px) {
            .pid-layout {
                grid-template-columns: 1fr auto 1fr;
                gap: 15px;
            }
            
            .pid-row {
                grid-template-columns: 50px 50px 50px 50px auto;
                gap: 6px;
            }
            
            .pid-row input {
                font-size: 11px;
                padding: 4px 6px;
                width: 45px;
                max-width: 50px;
            }
            
            .pid-row .btn {
                padding: 4px 8px;
                font-size: 10px;
            }
        }

        @media (max-width: 768px) {
            .pid-layout {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .pid-middle {
                order: -1;
                margin-bottom: 15px;
            }
            
            .copy-btn {
                padding: 12px 16px;
                font-size: 14px;
                width: 100%;
                max-width: 200px;
            }
            
            .pid-section {
                padding: 12px;
            }
            
            .pid-section h4 {
                font-size: 13px;
            }
            
            .pid-group h5 {
                font-size: 12px;
            }
            
            .pid-row {
                grid-template-columns: 1fr;
                gap: 8px;
                margin-bottom: 12px;
            }
            
            .pid-label {
                font-size: 11px;
                margin-bottom: 4px;
            }
            
            .pid-row input {
                padding: 8px;
                font-size: 14px;
                text-align: center;
            }
            
            .pid-row .btn {
                padding: 8px 12px;
                font-size: 12px;
                width: 100%;
            }
            
            .pid-controls {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .checkbox-label {
                font-size: 13px;
            }
            
            .note {
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .pid-panel {
                padding: 15px;
            }
            
            .pid-section {
                padding: 10px;
            }
            
            .pid-section h4 {
                font-size: 12px;
            }
            
            .pid-group h5 {
                font-size: 11px;
            }
            
            .pid-row input {
                font-size: 13px;
                padding: 6px;
            }
            
            .pid-row .btn {
                font-size: 11px;
                padding: 6px 10px;
            }
            
            .copy-btn {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .request-all .btn {
                padding: 8px 16px;
                font-size: 12px;
            }
        }

        .terminal-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .terminal-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .terminal-input {
            display: flex;
            gap: 10px;
        }

        .terminal-input input {
            flex: 1;
        }

        .switch-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .switch-up { background: #27ae60; }
        .switch-down { background: #e74c3c; }
        .switch-mid { background: #f39c12; }

        /* Flight Instruments Section */
        .flight-instruments {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .flight-instruments h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
        }


        .instrument-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .instrument-container h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .instrument-value {
            font-size: 1.1em;
            font-weight: 600;
            color: #34495e;
            margin-top: 10px;
        }

        .instrument-value.attitude {
            color: #e74c3c;
        }

        .instrument-value.heading {
            color: #3498db;
        }

        .instrument-value.altitude {
            color: #27ae60;
        }

        .instrument-value.speed {
            color: #f39c12;
        }

        .instrument-value.vario {
            color: #9b59b6;
        }

        .instrument-value.turn {
            color: #e67e22;
        }

        /* Responsive design for instruments */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .data-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .pid-grid {
                grid-template-columns: 1fr;
            }
            
            .instrument-container {
                margin-bottom: 15px;
            }
        }

        /* Custom styling for flight indicators */
        div.instrument {
            margin: 0 auto;
            display: block;
        }

        /* Dark theme for instruments */
        .dark-instruments {
            background: rgba(44, 62, 80, 0.9);
            color: white;
        }

        .dark-instruments h3 {
            color: #ecf0f1;
        }

        .dark-instruments .instrument-value {
            color: #bdc3c7;
        }

        /* Animation for instrument updates */
        .instrument-update {
            animation: pulse 0.3s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Instrument status indicators */
        .instrument-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #27ae60;
        }

        .status-inactive {
            background: #e74c3c;
        }

        .status-warning {
            background: #f39c12;
        }

        /* Control panel for instrument settings */
        .instrument-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .control-btn:hover {
            background: #2980b9;
        }

        .control-btn.active {
            background: #27ae60;
        }

        /* Data rate indicator */
        .data-rate {
            text-align: center;
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 10px;
        }
        
        /* Telemetry Dashboard Styles */
        .telemetry-overview {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .telemetry-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .telemetry-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .telemetry-card:hover {
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .card-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .card-status {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .telemetry-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-label {
            font-weight: 500;
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .telemetry-charts {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .telemetry-charts .chart-container:first-child {
            grid-column: 1 / -1;
        }
        
        .telemetry-controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-btn:hover {
            background: var(--secondary-color);
        }
        
        .telemetry-settings {
            display: flex;
            gap: 20px;
            margin-left: auto;
        }
        
        .telemetry-settings label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
        }
        
        .telemetry-settings input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        /* Data Rate Status Colors */
        .telemetry-card.good {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }
        
        .telemetry-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .telemetry-card.critical {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        .telemetry-card.disconnected {
            background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);
        }
        
        /* Telemetry Alert Styles */
        .telemetry-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }
        
        .telemetry-alert.warning {
            border-left: 4px solid #f39c12;
        }
        
        .telemetry-alert.critical {
            border-left: 4px solid #e74c3c;
        }
        
        .telemetry-alert i {
            font-size: 18px;
        }
        
        .telemetry-alert.warning i {
            color: #f39c12;
        }
        
        .telemetry-alert.critical i {
            color: #e74c3c;
        }
        
        .telemetry-alert button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            margin-left: auto;
        }
        
        .telemetry-alert button:hover {
            color: #333;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Real-time Graphs Styles */
        .graphs-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .graphs-section h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .graphs-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .graph-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .graph-container h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2em;
            text-align: center;
        }

        .graph-canvas {
            width: 100%;
            height: 300px;
            position: relative;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Fix canvas blurriness */
        .graph-canvas canvas {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .graph-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .graph-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.3s;
        }

        .graph-btn:hover {
            background: #2980b9;
        }

        .graph-btn.active {
            background: #27ae60;
        }

        /* Responsive design for graphs */
        @media (max-width: 768px) {
            .graphs-grid {
                grid-template-columns: 1fr;
            }
        }

        /* AHRS Panel Mini Graph Styles */
        .ahrs-mini-graph {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ahrs-mini-graph h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
            text-align: center;
        }

        .mini-graph-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            height: 300px;
            position: relative;
        }

        .mini-graph-canvas {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Mission Planning Styles */
        .mission-planning-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 20px;
        }

        .flight-mode-controls {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--light-bg);
            border-radius: 8px;
            border-left: 4px solid var(--secondary-color);
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: white;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mode-btn:hover {
            border-color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.1);
        }

        .mode-btn.active {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .current-mode {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
        }

        .mode-label {
            color: var(--primary-color);
        }

        .mode-value {
            color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.1);
            padding: 4px 12px;
            border-radius: 4px;
        }

        .waypoint-management {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--light-bg);
            border-radius: 8px;
            border-left: 4px solid var(--success-color);
        }

        .waypoint-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .waypoint-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .waypoint-table th,
        .waypoint-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .waypoint-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .waypoint-table tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .mission-stats {
            padding: 20px;
            background: var(--light-bg);
            border-radius: 8px;
            border-left: 4px solid var(--warning-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: var(--shadow);
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Professional HUD Styles */
        .hud-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 20px;
        }

        .hud-display {
            position: relative;
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #333;
        }

        /* Professional HUD Canvas */
        .hud-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 8px;
            z-index: 1;
        }

        .artificial-horizon {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #fff;
        }

        .horizon-background {
            position: relative;
            width: 100%;
            height: 100%;
            transform-origin: center center;
        }

        .sky {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(to bottom, #87CEEB, #4682B4);
        }

        .ground {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(to top, #8B4513, #A0522D);
        }

        .pitch-ladder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .pitch-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.8);
            transform-origin: center;
        }

        .pitch-line[data-angle="0"] { top: 50%; }
        .pitch-line[data-angle="10"] { top: 40%; }
        .pitch-line[data-angle="20"] { top: 30%; }
        .pitch-line[data-angle="30"] { top: 20%; }
        .pitch-line[data-angle="-10"] { top: 60%; }
        .pitch-line[data-angle="-20"] { top: 70%; }
        .pitch-line[data-angle="-30"] { top: 80%; }

        .attitude-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 12px solid #ff0000;
        }

        .roll-scale {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 20px;
        }

        .roll-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 10px solid #ff0000;
        }

        .hud-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .hud-top {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 16px;
        }

        .hud-left {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .hud-right {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .hud-bottom {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 16px;
        }

        .airspeed-indicator,
        .altitude-indicator {
            text-align: center;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .speed-value,
        .alt-value {
            font-size: 24px;
            line-height: 1;
        }

        .speed-label,
        .alt-label {
            font-size: 12px;
            margin-top: 5px;
        }

        .heading-value {
            font-size: 20px;
        }

        .vertical-speed {
            font-size: 16px;
        }

        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
        }

        .crosshair-h,
        .crosshair-v {
            position: absolute;
            background: #00ff00;
        }

        .crosshair-h {
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            transform: translateY(-50%);
        }

        .crosshair-v {
            left: 50%;
            top: 0;
            width: 2px;
            height: 100%;
            transform: translateX(-50%);
        }

        /* Responsive HUD */
        @media (max-width: 768px) {
            .hud-display {
                height: 300px;
            }

            .artificial-horizon {
                width: 200px;
                height: 200px;
            }

            .hud-top,
            .hud-bottom {
                font-size: 14px;
            }

            .speed-value,
            .alt-value {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Enhanced Header -->
        <div class="header">
            <h1><i class="fas fa-satellite-dish"></i> KMU Ground Station</h1>
            <div class="status-bar">
                <div id="connectionStatus" class="status-indicator status-disconnected">
                    <i class="fas fa-circle"></i>
                    <span id="statusText">Disconnected</span>
                </div>
                <div id="dataSourceStatus" class="status-indicator status-test-data">
                    <i class="fas fa-database"></i>
                    <span>Data Source:</span>
                    <span id="dataSourceText">Test Data</span>
                </div>
                <div class="status-indicator">
                    <i class="fas fa-battery-half"></i>
                    <span>Battery:</span>
                    <span id="batteryVoltage">0.0V</span>
                </div>
                <div class="status-indicator">
                    <i class="fas fa-toggle-on"></i>
                    <span>SwA:</span>
                    <span id="swaStatus">Up</span>
                </div>
                <div class="status-indicator">
                    <i class="fas fa-toggle-on"></i>
                    <span>SwC:</span>
                    <span id="swcStatus">Up</span>
                </div>
                <div class="status-indicator">
                    <i class="fas fa-shield-alt"></i>
                    <span>Failsafe:</span>
                    <span id="failsafeStatus">Normal</span>
                </div>
            </div>
        </div>

        <!-- Enhanced Connection Panel -->
        <div class="connection-panel">
            <h3><i class="fas fa-plug"></i> Connection Settings</h3>
            <div class="form-group">
                <label for="portSelect">Serial Port:</label>
                <select id="portSelect">
                    <option value="">Select Port...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="baudrateSelect">Baud Rate:</label>
                <select id="baudrateSelect">
                    <option value="9600">9600</option>
                    <option value="19200">19200</option>
                    <option value="38400">38400</option>
                    <option value="57600" selected>57600</option>
                    <option value="115200">115200</option>
                </select>
            </div>
            <button id="refreshPorts" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Refresh Ports
            </button>
            <button id="connectBtn" class="btn btn-success">
                <i class="fas fa-link"></i> Connect
            </button>
            <button id="disconnectBtn" class="btn btn-danger" disabled>
                <i class="fas fa-unlink"></i> Disconnect
            </button>
        </div>

        <!-- Tabbed Interface -->
        <div class="tab-container">
            <div class="tab-header">
                <button class="tab-button active" data-tab="flight-data">
                    <i class="fas fa-plane"></i> Flight Data
                </button>
                <button class="tab-button" data-tab="instruments">
                    <i class="fas fa-tachometer-alt"></i> Instruments
                </button>
                <button class="tab-button" data-tab="navigation">
                    <i class="fas fa-map"></i> Navigation
                </button>
                <button class="tab-button" data-tab="telemetry">
                    <i class="fas fa-chart-line"></i> Telemetry
                </button>
                <button class="tab-button" data-tab="mission-planning">
                    <i class="fas fa-route"></i> Mission Planning
                </button>
                <button class="tab-button" data-tab="advanced-charts">
                    <i class="fas fa-chart-area"></i> Advanced Charts
                </button>
                <button class="tab-button" data-tab="log-analysis">
                    <i class="fas fa-file-alt"></i> Log Analysis
                </button>
                <button class="tab-button" data-tab="3d-visualization">
                    <i class="fas fa-cube"></i> 3D Visualization
                </button>
                <button class="tab-button" data-tab="configuration">
                    <i class="fas fa-cog"></i> Configuration
                </button>
            </div>

            <!-- Flight Data Tab -->
            <div id="flight-data" class="tab-content active">
                <div class="dashboard">
                    <!-- AHRS Data Panel -->
                    <div class="panel">
                        <h3><i class="fas fa-compass"></i> AHRS Data</h3>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="label">Roll</div>
                                <div class="value" id="rollAngle">0.0</div>
                            </div>
                            <div class="data-item">
                                <div class="label">Pitch</div>
                                <div class="value" id="pitchAngle">0.0</div>
                            </div>
                            <div class="data-item">
                                <div class="label">Yaw</div>
                                <div class="value" id="yawAngle">0.0</div>
                            </div>
                            <div class="data-item">
                                <div class="label">Altitude</div>
                                <div class="value" id="altitude">0.0m</div>
                            </div>
                        </div>

                        <!-- Mini Attitude Graph -->
                        <div class="ahrs-mini-graph">
                            <div class="mini-graph-container">
                                <div class="mini-graph-canvas">
                                    <canvas id="ahrsMiniChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Data Logging Controls -->
                        <div class="logging-controls">
                            <h4><i class="fas fa-file-alt"></i> Data Logging</h4>
                            <div class="logging-buttons">
                                <button id="startLogging" class="btn btn-success">
                                    <i class="fas fa-play"></i> Start Logging
                                </button>
                                <button id="stopLogging" class="btn btn-danger" disabled>
                                    <i class="fas fa-stop"></i> Stop Logging
                                </button>
                            </div>
                            <div class="logging-status">
                                <span id="loggingStatus">Status: Not Logging</span>
                                <span id="loggingFilename"></span>
                            </div>
                        </div>
                    </div>

                    <!-- GPS Data Panel -->
                    <div class="panel">
                        <h3><i class="fas fa-map-marker-alt"></i> GPS & Navigation</h3>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="label">Latitude</div>
                                <div class="value" id="latitude">0.000000</div>
                            </div>
                            <div class="data-item">
                                <div class="label">Longitude</div>
                                <div class="value" id="longitude">0.000000</div>
                            </div>
                            <div class="data-item">
                                <div class="label">Heading</div>
                                <div class="value" id="heading">0.0</div>
                            </div>
                            <div class="data-item">
                                <div class="label">Speed</div>
                                <div class="value" id="speed">0.0 m/s</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instruments Tab -->
            <div id="instruments" class="tab-content">
                <!-- Professional HUD -->
                <div class="hud-container">
                    <h3><i class="fas fa-eye"></i> Professional HUD (Heads-Up Display)</h3>
                    <div class="hud-display">
                        <!-- Professional Canvas-based HUD -->
                        <canvas id="hudCanvas" class="hud-canvas" width="600" height="400"></canvas>
                        
                        <!-- HUD Data Overlay -->
                        <div class="hud-overlay">
                            <!-- Top Bar -->
                            <div class="hud-top">
                                <div class="flight-mode" id="hudFlightMode">MANUAL</div>
                                <div class="gps-status" id="hudGpsStatus">GPS: No Fix</div>
                                <div class="battery-status" id="hudBatteryStatus">BAT: 0.0V</div>
                            </div>
                            
                            <!-- Left Side -->
                            <div class="hud-left">
                                <div class="airspeed-indicator">
                                    <div class="speed-value" id="hudAirspeed">0</div>
                                    <div class="speed-label">AS</div>
                                </div>
                            </div>
                            
                            <!-- Right Side -->
                            <div class="hud-right">
                                <div class="altitude-indicator">
                                    <div class="alt-value" id="hudAltitude">0</div>
                                    <div class="alt-label">ALT</div>
                                </div>
                            </div>
                            
                            <!-- Bottom Bar -->
                            <div class="hud-bottom">
                                <div class="heading-indicator">
                                    <div class="heading-value" id="hudHeading">000</div>
                                </div>
                                <div class="vertical-speed" id="hudVerticalSpeed">0.0</div>
                            </div>
                            
                            <!-- Center Crosshair -->
                            <div class="crosshair">
                                <div class="crosshair-h"></div>
                                <div class="crosshair-v"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Traditional Flight Instruments -->
                <div class="flight-instruments">
                    <h3><i class="fas fa-tachometer-alt"></i> Traditional Instruments</h3>
                    <div class="instruments-grid-2x3">
                        <!-- Row 1 -->
                        <div class="instrument-container">
                            <h4><i class="fas fa-plane"></i> Attitude Indicator</h4>
                            <div id="attitude-instrument" style="width: 200px; height: 200px; margin: 0 auto;"></div>
                        </div>
                        <div class="instrument-container">
                            <h4><i class="fas fa-compass"></i> Heading Indicator</h4>
                            <div id="heading-instrument" style="width: 200px; height: 200px; margin: 0 auto;"></div>
                        </div>
                        <div class="instrument-container">
                            <h4><i class="fas fa-chart-area"></i> Altitude Indicator</h4>
                            <div id="altitude-instrument" style="width: 200px; height: 200px; margin: 0 auto;"></div>
                        </div>
                        
                        <!-- Row 2 -->
                        <div class="instrument-container">
                            <h4><i class="fas fa-tachometer-alt"></i> Speed Indicator</h4>
                            <div id="speed-instrument" style="width: 200px; height: 200px; margin: 0 auto;"></div>
                        </div>
                        <div class="instrument-container">
                            <h4><i class="fas fa-chart-line"></i> Vario Indicator</h4>
                            <div id="vario-instrument" style="width: 200px; height: 200px; margin: 0 auto;"></div>
                        </div>
                        <div class="instrument-container">
                            <h4><i class="fas fa-sync-alt"></i> Turn Rate</h4>
                            <div id="turn-instrument" style="width: 200px; height: 200px; margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tab -->
            <div id="navigation" class="tab-content">
                <div class="map-container">
                    <h3><i class="fas fa-map"></i> Flight Map</h3>
                    <div id="map"></div>
                </div>
            </div>

            <!-- Telemetry Tab -->
            <div id="telemetry" class="tab-content">
                <!-- Telemetry Overview -->
                <div class="telemetry-overview">
                    <h3><i class="fas fa-chart-line"></i> Real-time Telemetry Dashboard</h3>
                    
                    <!-- Data Rate Status Cards -->
                    <div class="telemetry-cards">
                        <div class="telemetry-card">
                            <div class="card-header">
                                <i class="fas fa-satellite-dish"></i>
                                <span>AHRS Data Rate</span>
                            </div>
                            <div class="card-value" id="ahrsRate">0 Hz</div>
                            <div class="card-status" id="ahrsStatus">Disconnected</div>
                        </div>
                        
                        <div class="telemetry-card">
                            <div class="card-header">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>GPS Data Rate</span>
                            </div>
                            <div class="card-value" id="gpsRate">0 Hz</div>
                            <div class="card-status" id="gpsStatus">No Fix</div>
                        </div>
                        
                        <div class="telemetry-card">
                            <div class="card-header">
                                <i class="fas fa-battery-half"></i>
                                <span>Power Data Rate</span>
                            </div>
                            <div class="card-value" id="powerRate">0 Hz</div>
                            <div class="card-status" id="powerStatus">Normal</div>
                        </div>
                        
                        <div class="telemetry-card">
                            <div class="card-header">
                                <i class="fas fa-signal"></i>
                                <span>Connection Quality</span>
                            </div>
                            <div class="card-value" id="connectionQuality">0%</div>
                            <div class="card-status" id="connectionStatus">Poor</div>
                        </div>
                    </div>
                    
                    <!-- Telemetry Statistics -->
                    <div class="telemetry-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Messages:</span>
                            <span class="stat-value" id="totalMessages">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Messages/sec:</span>
                            <span class="stat-value" id="messagesPerSecond">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Data Loss:</span>
                            <span class="stat-value" id="dataLoss">0%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Uptime:</span>
                            <span class="stat-value" id="uptime">00:00:00</span>
                        </div>
                    </div>
                </div>
                
                <!-- Real-time Charts -->
                <div class="telemetry-charts">
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-line"></i> Real-time Telemetry Data</h3>
                        <canvas id="telemetryChart" width="800" height="300"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-bar"></i> Data Rate Analysis</h3>
                        <canvas id="dataRateChart" width="800" height="200"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-pie"></i> Message Distribution</h3>
                        <canvas id="messageDistributionChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <!-- Telemetry Controls -->
                <div class="telemetry-controls">
                    <button class="control-btn" onclick="resetTelemetryStats()">
                        <i class="fas fa-redo"></i> Reset Statistics
                    </button>
                    <button class="control-btn" onclick="exportTelemetryData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                    <button class="control-btn" onclick="toggleTelemetryAlerts()">
                        <i class="fas fa-bell"></i> Toggle Alerts
                    </button>
                    <div class="telemetry-settings">
                        <label>
                            <input type="checkbox" id="enableDataRateAlerts" checked>
                            Enable Data Rate Alerts
                        </label>
                        <label>
                            <input type="checkbox" id="enableConnectionAlerts" checked>
                            Enable Connection Alerts
                        </label>
                    </div>
                </div>
            </div>

            <!-- Mission Planning Tab -->
            <div id="mission-planning" class="tab-content">
                <!-- Mission Planning Interface -->
                <div class="mission-planning-panel">
                    <h3><i class="fas fa-route"></i> Mission Planning</h3>
                    
                    <!-- Flight Mode Controls -->
                    <div class="flight-mode-controls">
                        <h4><i class="fas fa-plane"></i> Flight Mode Control</h4>
                        <div class="mode-buttons">
                            <button class="mode-btn" data-mode="MANUAL" onclick="setFlightMode('MANUAL')">
                                <i class="fas fa-hand-paper"></i> Manual
                            </button>
                            <button class="mode-btn" data-mode="STABILIZE" onclick="setFlightMode('STABILIZE')">
                                <i class="fas fa-balance-scale"></i> Stabilize
                            </button>
                            <button class="mode-btn" data-mode="ALT_HOLD" onclick="setFlightMode('ALT_HOLD')">
                                <i class="fas fa-chart-area"></i> Alt Hold
                            </button>
                            <button class="mode-btn" data-mode="AUTO" onclick="setFlightMode('AUTO')">
                                <i class="fas fa-route"></i> Auto
                            </button>
                            <button class="mode-btn" data-mode="RTL" onclick="setFlightMode('RTL')">
                                <i class="fas fa-home"></i> RTL
                            </button>
                            <button class="mode-btn" data-mode="LAND" onclick="setFlightMode('LAND')">
                                <i class="fas fa-landing"></i> Land
                            </button>
                        </div>
                        <div class="current-mode">
                            <span class="mode-label">Current Mode:</span>
                            <span id="currentFlightMode" class="mode-value">MANUAL</span>
                        </div>
                    </div>

                    <!-- Waypoint Management -->
                    <div class="waypoint-management">
                        <h4><i class="fas fa-map-marker-alt"></i> Waypoint Management</h4>
                        <div class="waypoint-controls">
                            <button class="btn btn-primary" onclick="addWaypoint()">
                                <i class="fas fa-plus"></i> Add Waypoint
                            </button>
                            <button class="btn btn-success" onclick="uploadMission()">
                                <i class="fas fa-upload"></i> Upload Mission
                            </button>
                            <button class="btn btn-info" onclick="downloadMission()">
                                <i class="fas fa-download"></i> Download Mission
                            </button>
                            <button class="btn btn-warning" onclick="clearMission()">
                                <i class="fas fa-trash"></i> Clear Mission
                            </button>
                        </div>
                        
                        <!-- Waypoint List -->
                        <div class="waypoint-list">
                            <table class="waypoint-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Latitude</th>
                                        <th>Longitude</th>
                                        <th>Altitude</th>
                                        <th>Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="waypointTableBody">
                                    <!-- Waypoints will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mission Statistics -->
                    <div class="mission-stats">
                        <h4><i class="fas fa-chart-bar"></i> Mission Statistics</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-label">Total Waypoints</div>
                                <div class="stat-value" id="totalWaypoints">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Total Distance</div>
                                <div class="stat-value" id="totalDistance">0.0 m</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Estimated Time</div>
                                <div class="stat-value" id="estimatedTime">0:00</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Mission Status</div>
                                <div class="stat-value" id="missionStatus">Ready</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Tab -->
            <div id="configuration" class="tab-content">
                <!-- PID Control Panel -->
                <div class="pid-panel">
                    <h3><i class="fas fa-sliders-h"></i> PID Gain Setup</h3>
                    
                    <!-- Switch Status Warning -->
                    <div class="switch-status">
                        <span class="switch-label">Switch A Status:</span>
                        <span id="switchAStatus" class="switch-value">Unknown</span>
                        <div class="switch-note">
                            <strong> PID Changes Only Work When Switch A is DOWN (1000)</strong><br>
                            Switch A UP (2000) = Flight Mode | Switch A DOWN (1000) = PID Tuning Mode
                        </div>
                    </div>
                    
                    <!-- PID Control Layout -->
                    <div class="pid-layout">
                        <!-- Left Section: Setting and Sending PID Gains -->
                        <div class="pid-section">
                            <h4>Setting and Sending PID Gains</h4>
                            
                            <!-- ROLL Controls -->
                            <div class="pid-group">
                                <h5>ROLL</h5>
                                <div class="pid-row">
                                    <span class="pid-label">Inner:</span>
                                    <input type="number" id="rollInnerP" placeholder="P" step="0.1" value="5">
                                    <input type="number" id="rollInnerI" placeholder="I" step="0.1" value="5">
                                    <input type="number" id="rollInnerD" placeholder="D" step="0.1" value="1.7">
                                    <button class="btn btn-primary" onclick="sendPIDWithStatusCheck('roll_inner')">Send</button>
                                </div>
                                <div class="pid-row">
                                    <span class="pid-label">Outer:</span>
                                    <input type="number" id="rollOuterP" placeholder="P" step="0.1" value="45">
                                    <input type="number" id="rollOuterI" placeholder="I" step="0.1" value="3">
                                    <input type="number" id="rollOuterD" placeholder="D" step="0.1" value="4">
                                    <button class="btn btn-primary" onclick="sendPIDWithStatusCheck('roll_outer')">Send</button>
                                </div>
                            </div>
                            
                            <!-- PITCH Controls -->
                            <div class="pid-group">
                                <h5>PITCH</h5>
                                <div class="pid-row">
                                    <span class="pid-label">Inner:</span>
                                    <input type="number" id="pitchInnerP" placeholder="P" step="0.1" value="6.5">
                                    <input type="number" id="pitchInnerI" placeholder="I" step="0.1" value="5">
                                    <input type="number" id="pitchInnerD" placeholder="D" step="0.1" value="1.5">
                                    <button class="btn btn-primary" onclick="sendPIDWithStatusCheck('pitch_inner')">Send</button>
                                </div>
                                <div class="pid-row">
                                    <span class="pid-label">Outer:</span>
                                    <input type="number" id="pitchOuterP" placeholder="P" step="0.1" value="45">
                                    <input type="number" id="pitchOuterI" placeholder="I" step="0.1" value="3">
                                    <input type="number" id="pitchOuterD" placeholder="D" step="0.1" value="4">
                                    <button class="btn btn-primary" onclick="sendPIDWithStatusCheck('pitch_outer')">Send</button>
                                </div>
                            </div>
                            
                            <!-- YAW Controls -->
                            <div class="pid-group">
                                <h5>YAW</h5>
                                <div class="pid-row">
                                    <span class="pid-label">Angle:</span>
                                    <input type="number" id="yawAngleP" placeholder="P" step="0.1" value="50">
                                    <input type="number" id="yawAngleI" placeholder="I" step="0.1" value="0">
                                    <input type="number" id="yawAngleD" placeholder="D" step="0.1" value="20">
                                    <button class="btn btn-primary" onclick="sendPIDWithStatusCheck('yaw_angle')">Send</button>
                                </div>
                                <div class="pid-row">
                                    <span class="pid-label">Rate:</span>
                                    <input type="number" id="yawRateP" placeholder="P" step="0.1" value="15">
                                    <input type="number" id="yawRateI" placeholder="I" step="0.1" value="0">
                                    <input type="number" id="yawRateD" placeholder="D" step="0.1" value="2">
                                    <button class="btn btn-primary" onclick="sendPIDWithStatusCheck('yaw_rate')">Send</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Middle Section: Copy Button -->
                        <div class="pid-middle">
                            <button class="btn btn-secondary copy-btn" onclick="copyPIDGains()"> Copy </button>
                        </div>
                        
                        <!-- Right Section: Received from FC -->
                        <div class="pid-section">
                            <h4>====== Received from FC ======</h4>
                            
                            <!-- ROLL Received -->
                            <div class="pid-group">
                                <h5>ROLL</h5>
                                <div class="pid-row">
                                    <span class="pid-label">Inner:</span>
                                    <input type="text" id="rollInnerP_received" placeholder="-" readonly>
                                    <input type="text" id="rollInnerI_received" placeholder="-" readonly>
                                    <input type="text" id="rollInnerD_received" placeholder="-" readonly>
                                    <button class="btn btn-success" onclick="requestPID(0)">Request</button>
                                </div>
                                <div class="pid-row">
                                    <span class="pid-label">Outer:</span>
                                    <input type="text" id="rollOuterP_received" placeholder="-" readonly>
                                    <input type="text" id="rollOuterI_received" placeholder="-" readonly>
                                    <input type="text" id="rollOuterD_received" placeholder="-" readonly>
                                    <button class="btn btn-success" onclick="requestPID(1)">Request</button>
                                </div>
                            </div>
                            
                            <!-- PITCH Received -->
                            <div class="pid-group">
                                <h5>PITCH</h5>
                                <div class="pid-row">
                                    <span class="pid-label">Inner:</span>
                                    <input type="text" id="pitchInnerP_received" placeholder="-" readonly>
                                    <input type="text" id="pitchInnerI_received" placeholder="-" readonly>
                                    <input type="text" id="pitchInnerD_received" placeholder="-" readonly>
                                    <button class="btn btn-success" onclick="requestPID(2)">Request</button>
                                </div>
                                <div class="pid-row">
                                    <span class="pid-label">Outer:</span>
                                    <input type="text" id="pitchOuterP_received" placeholder="-" readonly>
                                    <input type="text" id="pitchOuterI_received" placeholder="-" readonly>
                                    <input type="text" id="pitchOuterD_received" placeholder="-" readonly>
                                    <button class="btn btn-success" onclick="requestPID(3)">Request</button>
                                </div>
                            </div>
                            
                            <!-- YAW Received -->
                            <div class="pid-group">
                                <h5>YAW</h5>
                                <div class="pid-row">
                                    <span class="pid-label">Angle:</span>
                                    <input type="text" id="yawAngleP_received" placeholder="-" readonly>
                                    <input type="text" id="yawAngleI_received" placeholder="-" readonly>
                                    <input type="text" id="yawAngleD_received" placeholder="-" readonly>
                                    <button class="btn btn-success" onclick="requestPID(4)">Request</button>
                                </div>
                                <div class="pid-row">
                                    <span class="pid-label">Rate:</span>
                                    <input type="text" id="yawRateP_received" placeholder="-" readonly>
                                    <input type="text" id="yawRateI_received" placeholder="-" readonly>
                                    <input type="text" id="yawRateD_received" placeholder="-" readonly>
                                    <button class="btn btn-success" onclick="requestPID(5)">Request</button>
                                </div>
                            </div>
                            
                            <!-- Request All Button -->
                            <div class="request-all">
                                <button class="btn btn-warning" onclick="requestAllPID()">Request All Gain</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Controls -->
                    <div class="pid-controls">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rpCoupling"> R, P Coupling
                        </label>
                        <span class="note">Only numbers available <span class="note-icon"></span></span>
                        <button class="btn btn-info" onclick="openFolder()">Open Folder</button>
                    </div>
                </div>

                <!-- Terminal Panel -->
                <div class="terminal-panel">
                    <h3><i class="fas fa-terminal"></i> Terminal</h3>
                    <div class="terminal-output" id="terminalOutput"></div>
                    <div class="terminal-input">
                        <input type="text" id="terminalInput" placeholder="Enter message...">
                        <select id="terminalMode">
                            <option value="ascii">ASCII</option>
                            <option value="hex">HEX</option>
                        </select>
                        <button class="btn btn-primary" onclick="sendTerminal()">Send</button>
                    </div>
                </div>
            </div>

            <!-- Advanced Charts Tab -->
            <div id="advanced-charts" class="tab-content">
                <div class="panel">
                    <h3><i class="fas fa-chart-area"></i> Multi-Series Data Plotting</h3>
                    <div class="chart-container">
                        <canvas id="multiSeriesChart" width="800" height="400"></canvas>
                    </div>
                    <div class="chart-controls">
                        <button class="chart-btn" onclick="toggleSeries('attitude')">Attitude</button>
                        <button class="chart-btn" onclick="toggleSeries('navigation')">Navigation</button>
                        <button class="chart-btn" onclick="toggleSeries('power')">Power</button>
                        <button class="chart-btn" onclick="toggleSeries('pid')">PID</button>
                        <button class="chart-btn" onclick="exportChartData()">Export Data</button>
                    </div>
                </div>
                
                <div class="panel">
                    <h3><i class="fas fa-wave-square"></i> Real-time Spectrogram</h3>
                    <div class="spectrogram-container">
                        <canvas id="spectrogramCanvas" width="800" height="300"></canvas>
                    </div>
                    <div class="spectrogram-controls">
                        <button class="spectrogram-btn" onclick="startSpectrogram()">Start Analysis</button>
                        <button class="spectrogram-btn" onclick="stopSpectrogram()">Stop Analysis</button>
                        <button class="spectrogram-btn" onclick="clearSpectrogram()">Clear</button>
                        <select id="spectrogramSource">
                            <option value="gyro">Gyroscope</option>
                            <option value="accel">Accelerometer</option>
                            <option value="mag">Magnetometer</option>
                            <option value="pressure">Pressure</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Log Analysis Tab -->
            <div id="log-analysis" class="tab-content">
                <div class="panel">
                    <h3><i class="fas fa-file-alt"></i> Log File Analysis</h3>
                    <div class="log-analysis-controls">
                        <input type="file" id="logFileInput" accept=".csv,.txt,.json" multiple>
                        <button class="log-btn" onclick="loadLogFiles()">Load Log Files</button>
                        <button class="log-btn" onclick="analyzeLogData()">Analyze Data</button>
                        <button class="log-btn" onclick="exportAnalysis()">Export Analysis</button>
                    </div>
                    <div class="log-analysis-results">
                        <div class="analysis-chart">
                            <canvas id="logAnalysisChart" width="800" height="400"></canvas>
                        </div>
                        <div class="analysis-stats">
                            <h4>Analysis Statistics</h4>
                            <div id="analysisStats"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3D Visualization Tab -->
            <div id="3d-visualization" class="tab-content">
                <div class="panel">
                    <h3><i class="fas fa-cube"></i> 3D Flight Visualization</h3>
                    <div class="cesium-container">
                        <div id="cesiumContainer" style="width: 100%; height: 600px;"></div>
                    </div>
                    <div class="cesium-controls">
                        <button class="cesium-btn" onclick="reset3DView()">Reset View</button>
                        <button class="cesium-btn" onclick="setCameraMode('follow')">Follow Aircraft</button>
                        <button class="cesium-btn" onclick="setCameraMode('free')">Free Camera</button>
                        <button class="cesium-btn" onclick="setCameraMode('cockpit')">Cockpit View</button>
                        <button class="cesium-btn" onclick="toggleTerrain()">Toggle Terrain</button>
                        <button class="cesium-btn" onclick="toggleFlightPath()">Toggle Flight Path</button>
                        <button class="cesium-btn" onclick="toggleWaypoints()">Toggle Waypoints</button>
                        <button class="cesium-btn" onclick="toggleObstacles()">Toggle Obstacles</button>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        <strong>Controls:</strong> Press 1 (Follow), 2 (Free), 3 (Cockpit), R (Reset)
                    </div>
                </div>
            </div>
        </div>



        <!-- Real-time Graphs Panel -->
        <div class="graphs-section">
            <h2> Real-time Flight Data Graphs</h2>
            <div class="graphs-grid">
                <div class="graph-container">
                    <h3>Attitude Data (Roll, Pitch, Yaw)</h3>
                    <div class="graph-canvas">
                        <canvas id="attitudeChart"></canvas>
                    </div>
                    <div class="graph-controls">
                        <button class="graph-btn active" onclick="toggleGraph('attitude', 'roll')">Roll</button>
                        <button class="graph-btn active" onclick="toggleGraph('attitude', 'pitch')">Pitch</button>
                        <button class="graph-btn active" onclick="toggleGraph('attitude', 'yaw')">Yaw</button>
                        <button class="graph-btn" onclick="clearGraph('attitude')">Clear</button>
                    </div>
                </div>
                <div class="graph-container">
                    <h3>Altitude & Speed</h3>
                    <div class="graph-canvas">
                        <canvas id="altitudeSpeedChart"></canvas>
                    </div>
                    <div class="graph-controls">
                        <button class="graph-btn active" onclick="toggleGraph('altitudeSpeed', 'altitude')">Altitude</button>
                        <button class="graph-btn active" onclick="toggleGraph('altitudeSpeed', 'speed')">Speed</button>
                        <button class="graph-btn" onclick="clearGraph('altitudeSpeed')">Clear</button>
                    </div>
                </div>
                <div class="graph-container">
                    <h3>Battery Voltage & Vertical Speed</h3>
                    <div class="graph-canvas">
                        <canvas id="batteryVarioChart"></canvas>
                    </div>
                    <div class="graph-controls">
                        <button class="graph-btn active" onclick="toggleGraph('batteryVario', 'battery')">Battery</button>
                        <button class="graph-btn active" onclick="toggleGraph('batteryVario', 'vario')">Vario</button>
                        <button class="graph-btn" onclick="clearGraph('batteryVario')">Clear</button>
                    </div>
                </div>
                <div class="graph-container">
                    <h3>GPS Data</h3>
                    <div class="graph-canvas">
                        <canvas id="gpsChart"></canvas>
                    </div>
                    <div class="graph-controls">
                        <button class="graph-btn active" onclick="toggleGraph('gps', 'latitude')">Latitude</button>
                        <button class="graph-btn active" onclick="toggleGraph('gps', 'longitude')">Longitude</button>
                        <button class="graph-btn" onclick="clearGraph('gps')">Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tabbed Interface Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    this.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                });
            });
        });

        // Initialize Socket.IO
        const socket = io();
        
        // Initialize map
        const map = L.map('map').setView([37.7749, -122.4194], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' OpenStreetMap contributors'
        }).addTo(map);
        
        let droneMarker = null;
        let pathLine = null;
        let pathCoordinates = [];
        
        // Connection management
        document.getElementById('refreshPorts').addEventListener('click', refreshPorts);
        document.getElementById('connectBtn').addEventListener('click', connect);
        document.getElementById('disconnectBtn').addEventListener('click', disconnect);
        
        async function refreshPorts() {
            try {
                const response = await fetch('/api/ports');
                const data = await response.json();
                
                const portSelect = document.getElementById('portSelect');
                portSelect.innerHTML = '<option value="">Select Port...</option>';
                
                data.ports.forEach(port => {
                    const option = document.createElement('option');
                    option.value = port;
                    option.textContent = port;
                    // Select saved port if available
                    if (port === data.saved_port) {
                        option.selected = true;
                    }
                    portSelect.appendChild(option);
                });
                
                // Set saved baudrate
                const baudrateSelect = document.getElementById('baudrateSelect');
                if (baudrateSelect && data.saved_baudrate) {
                    baudrateSelect.value = data.saved_baudrate;
                }
                
            } catch (error) {
                console.error('Failed to refresh ports:', error);
            }
        }
        
        async function connect() {
            const port = document.getElementById('portSelect').value;
            const baudrate = document.getElementById('baudrateSelect').value;
            
            if (!port) {
                alert('Please select a port');
                return;
            }
            
            try {
                const response = await fetch('/api/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ port, baudrate })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    updateConnectionStatus(true);
                    addTerminalMessage(`Connected to ${port} at ${baudrate} baud`);
                } else {
                    alert('Connection failed: ' + result.message);
                }
            } catch (error) {
                console.error('Connection error:', error);
                alert('Connection failed');
            }
        }
        
        async function disconnect() {
            try {
                const response = await fetch('/api/disconnect');
                const result = await response.json();
                if (result.status === 'success') {
                    updateConnectionStatus(false);
                    addTerminalMessage('Disconnected');
                }
            } catch (error) {
                console.error('Disconnect error:', error);
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const dataSourceStatus = document.getElementById('dataSourceStatus');
            const dataSourceText = document.getElementById('dataSourceText');
            
            if (connected) {
                statusIndicator.className = 'status-indicator status-connected pulse';
                statusText.textContent = 'Connected';
                dataSourceStatus.className = 'status-indicator status-real-data';
                dataSourceText.textContent = 'Real FC Data';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                
                // Update status icon
                const statusIcon = statusIndicator.querySelector('i');
                statusIcon.className = 'fas fa-circle';
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.textContent = 'Disconnected';
                dataSourceStatus.className = 'status-indicator status-test-data';
                dataSourceText.textContent = 'Test Data';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                
                // Update status icon
                const statusIcon = statusIndicator.querySelector('i');
                statusIcon.className = 'fas fa-circle';
                
                // Clear data when disconnected
            }
        }

        // Enhanced status indicator updates
        function updateBatteryStatus(voltage) {
            const batteryIndicator = document.querySelector('.status-indicator:nth-child(3)');
            const batteryValue = document.getElementById('batteryVoltage');
            const batteryIcon = batteryIndicator.querySelector('i');
            
            batteryValue.textContent = `${voltage.toFixed(1)}V`;
            
            // Update battery icon based on voltage level
            if (voltage > 12.0) {
                batteryIcon.className = 'fas fa-battery-full';
                batteryIndicator.className = 'status-indicator status-connected';
            } else if (voltage > 11.0) {
                batteryIcon.className = 'fas fa-battery-three-quarters';
                batteryIndicator.className = 'status-indicator status-test-data';
            } else if (voltage > 10.0) {
                batteryIcon.className = 'fas fa-battery-half';
                batteryIndicator.className = 'status-indicator status-test-data';
            } else if (voltage > 9.0) {
                batteryIcon.className = 'fas fa-battery-quarter';
                batteryIndicator.className = 'status-indicator status-disconnected';
            } else {
                batteryIcon.className = 'fas fa-battery-empty';
                batteryIndicator.className = 'status-indicator status-disconnected';
            }
        }

        function updateSwitchStatus(swa, swc, failsafe) {
            const swaIndicator = document.querySelector('.status-indicator:nth-child(4)');
            const swcIndicator = document.querySelector('.status-indicator:nth-child(5)');
            const failsafeIndicator = document.querySelector('.status-indicator:nth-child(6)');
            
            // Update SwA status
            const swaValue = document.getElementById('swaStatus');
            const swaIcon = swaIndicator.querySelector('i');
            if (swa === 0) {
                swaValue.textContent = 'Up';
                swaIcon.className = 'fas fa-toggle-on';
                swaIndicator.className = 'status-indicator status-test-data';
            } else {
                swaValue.textContent = 'Down';
                swaIcon.className = 'fas fa-toggle-off';
                swaIndicator.className = 'status-indicator status-connected';
            }
            
            // Update SwC status
            const swcValue = document.getElementById('swcStatus');
            const swcIcon = swcIndicator.querySelector('i');
            if (swc === 0) {
                swcValue.textContent = 'Up';
                swcIcon.className = 'fas fa-toggle-on';
                swcIndicator.className = 'status-indicator status-test-data';
            } else if (swc === 1) {
                swcValue.textContent = 'Mid';
                swcIcon.className = 'fas fa-toggle-on';
                swcIndicator.className = 'status-indicator status-test-data';
            } else {
                swcValue.textContent = 'Down';
                swcIcon.className = 'fas fa-toggle-off';
                swcIndicator.className = 'status-indicator status-connected';
            }
            
            // Update Failsafe status
            const failsafeValue = document.getElementById('failsafeStatus');
            const failsafeIcon = failsafeIndicator.querySelector('i');
            if (failsafe === 0) {
                failsafeValue.textContent = 'Normal';
                failsafeIcon.className = 'fas fa-shield-alt';
                failsafeIndicator.className = 'status-indicator status-connected';
            } else if (failsafe === 1) {
                failsafeValue.textContent = 'Triggered';
                failsafeIcon.className = 'fas fa-exclamation-triangle';
                failsafeIndicator.className = 'status-indicator status-disconnected pulse';
            } else {
                failsafeValue.textContent = 'No iBus';
                failsafeIcon.className = 'fas fa-exclamation-circle';
                failsafeIndicator.className = 'status-indicator status-disconnected';
            }
        }
        
        // Socket.IO event handlers
        socket.on('ahrs_data', function(data) {
            updateAHRSData(data);
        });
        
        socket.on('gps_data', function(data) {
            updateGPSData(data);
            updateMap(data);
        });
        
        socket.on('system_status', function(data) {
            updateSystemStatus(data);
        });
        
        socket.on('flight_data', function(data) {
            updateFlightData(data);
        });
        
        socket.on('navigation_data', function(data) {
            updateNavigationData(data);
        });
        
        socket.on('power_system', function(data) {
            updatePowerSystem(data);
        });
        
        socket.on('remote_control', function(data) {
            updateRemoteControl(data);
        });
        
        socket.on('pid_gain_ack', function(data) {
            updatePIDGains(data);
            addTerminalMessage(`Received ${data.type} PID: P=${data.p}, I=${data.i}, D=${data.d}`);
        });
        
        // Data polling disabled - only real FC data via SocketIO
        // No automatic polling to prevent fake data generation
        
        // Data Logging Controls
        document.getElementById('startLogging').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/start_logging', { method: 'POST' });
                const result = await response.json();
                if (result.status === 'success') {
                    document.getElementById('startLogging').disabled = true;
                    document.getElementById('stopLogging').disabled = false;
                    document.getElementById('loggingStatus').textContent = 'Status: Logging Active';
                    document.getElementById('loggingFilename').textContent = `File: ${result.filename}`;
                    addTerminalMessage(`Data logging started: ${result.filename}`);
                } else {
                    addTerminalMessage(`Failed to start logging: ${result.message}`);
                }
            } catch (error) {
                console.error('Start logging error:', error);
                addTerminalMessage('Failed to start data logging');
            }
        });
        
        document.getElementById('stopLogging').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/stop_logging', { method: 'POST' });
                const result = await response.json();
                if (result.status === 'success') {
                    document.getElementById('startLogging').disabled = false;
                    document.getElementById('stopLogging').disabled = true;
                    document.getElementById('loggingStatus').textContent = 'Status: Not Logging';
                    document.getElementById('loggingFilename').textContent = '';
                    addTerminalMessage(`Data logging stopped. Duration: ${result.duration?.toFixed(1)}s`);
                } else {
                    addTerminalMessage(`Failed to stop logging: ${result.message}`);
                }
            } catch (error) {
                console.error('Stop logging error:', error);
                addTerminalMessage('Failed to stop data logging');
            }
        });
        
        function updateAHRSData(data) {
            document.getElementById('rollAngle').textContent = data.roll_angle.toFixed(2) + '';
            document.getElementById('pitchAngle').textContent = data.pitch_angle.toFixed(2) + '';
            document.getElementById('yawAngle').textContent = data.yaw_angle.toFixed(2) + '';
            document.getElementById('altitude').textContent = data.altitude.toFixed(1) + 'm';
            
            // Update HUD data for advanced visualizations
            hudData.roll = data.roll_angle;
            hudData.pitch = data.pitch_angle;
            hudData.yaw = data.yaw_angle;
            hudData.altitude = data.altitude;
            
            // Update advanced visualizations
            updateAdvancedVisualizations(data);
            
            // Update telemetry dashboard
            updateTelemetryFromData(data);
        }
        
        function updateGPSData(data) {
            document.getElementById('latitude').textContent = data.latitude.toFixed(6) + '';
            document.getElementById('longitude').textContent = data.longitude.toFixed(6) + '';
            
            // Update HUD data for advanced visualizations
            hudData.batteryVoltage = data.battery_voltage;
            hudData.gpsStatus = data.gps_fix ? 'GPS Fix' : 'No Fix';
            
            // Update enhanced status indicators
            updateBatteryStatus(data.battery_voltage);
            updateSwitchStatus(data.swa, data.swc, data.failsafe);
            
            // Update advanced visualizations with GPS data
            updateAdvancedVisualizations(data);
            
            // Update telemetry dashboard
            updateTelemetryFromData(data);
        }
        
        function updateMap(data) {
            const lat = data.latitude;
            const lng = data.longitude;
            
            if (lat !== 0 && lng !== 0) {
                if (!droneMarker) {
                    droneMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'drone-marker',
                            html: '',
                            iconSize: [30, 30]
                        })
                    }).addTo(map);
                } else {
                    droneMarker.setLatLng([lat, lng]);
                }
                
                // Add to path
                pathCoordinates.push([lat, lng]);
                if (pathCoordinates.length > 30) {
                    pathCoordinates.shift();
                }
                
                if (pathLine) {
                    map.removeLayer(pathLine);
                }
                
                if (pathCoordinates.length > 1) {
                    pathLine = L.polyline(pathCoordinates, {
                        color: '#e74c3c',
                        weight: 3,
                        opacity: 0.7
                    }).addTo(map);
                }
                
                map.setView([lat, lng]);
            }
        }
        
        function updatePIDGains(data) {
            const type = data.type;
            const pInput = document.getElementById(type + 'P');
            const iInput = document.getElementById(type + 'I');
            const dInput = document.getElementById(type + 'D');
            
            // Update received fields
            const pReceived = document.getElementById(type + 'P_received');
            const iReceived = document.getElementById(type + 'I_received');
            const dReceived = document.getElementById(type + 'D_received');
            
            if (pReceived && iReceived && dReceived) {
                pReceived.value = data.p;
                iReceived.value = data.i;
                dReceived.value = data.d;
            }
            
            // Also update the input fields if they exist
            if (pInput && iInput && dInput) {
                pInput.value = data.p;
                iInput.value = data.i;
                dInput.value = data.d;
            }
        }
        
        function copyPIDGains() {
            // Copy values from left section to right section
            const pidTypes = ['rollInner', 'rollOuter', 'pitchInner', 'pitchOuter', 'yawAngle', 'yawRate'];
            
            pidTypes.forEach(type => {
                const pValue = document.getElementById(type + 'P').value;
                const iValue = document.getElementById(type + 'I').value;
                const dValue = document.getElementById(type + 'D').value;
                
                document.getElementById(type + 'P_received').value = pValue;
                document.getElementById(type + 'I_received').value = iValue;
                document.getElementById(type + 'D_received').value = dValue;
            });
            
            addTerminalMessage('PID gains copied from left to right section');
        }
        
        function openFolder() {
            // Open the application folder in file explorer
            // For Windows, we'll use a different approach
            if (navigator.platform.indexOf('Win') !== -1) {
                // On Windows, we can't directly open folders from browser
                // Instead, show a message with the folder path
                alert('Application folder: D:\\internship\\KMU Ground station\\snsorlog');
            } else {
                // For other platforms, try to open the folder
                window.open('file:///D:/internship/KMU Ground station/snsorlog', '_blank');
            }
        }
        
        async function sendPID(type) {
            const p = parseFloat(document.getElementById(type + 'P').value) || 0;
            const i = parseFloat(document.getElementById(type + 'I').value) || 0;
            const d = parseFloat(document.getElementById(type + 'D').value) || 0;
            
            // Debug logging
            console.log(`Sending PID ${type}: P=${p}, I=${i}, D=${d}`);
            addTerminalMessage(`Attempting to send ${type} PID: P=${p}, I=${i}, D=${d}`);
            
            try {
                const response = await fetch('/api/send_pid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type, p, i, d })
                });
                
                const result = await response.json();
                console.log('PID send response:', result);
                
                if (result.status === 'success') {
                    addTerminalMessage(` Successfully sent ${type} PID: P=${p}, I=${i}, D=${d}`);
                } else {
                    addTerminalMessage(` Failed to send ${type} PID: ${result.message}`);
                }
            } catch (error) {
                console.error('Send PID error:', error);
                addTerminalMessage(` Send PID failed: ${error.message}`);
            }
        }
        
        // Function to check connection status
        async function checkConnectionStatus() {
            try {
                const response = await fetch('/api/connection_status');
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Response is not JSON');
                }
                
                const result = await response.json();
                
                console.log('Connection status:', result);
                addTerminalMessage(`Connection: connected=${result.is_connected}, port=${result.serial_port}, port_open=${result.port_open}, baud=${result.baud_rate}`);
                
                return result;
            } catch (error) {
                console.error('Connection status check failed:', error);
                addTerminalMessage(` Connection status check failed: ${error.message}`);
                return null;
            }
        }
        
        // Check connection status before sending PID
        async function sendPIDWithStatusCheck(type) {
            const status = await checkConnectionStatus();
            if (!status || !status.is_connected) {
                addTerminalMessage(' Cannot send PID: Not connected to flight controller');
                return;
            }
            
            // Check if switch A is in the correct position (down = 1000)
            addTerminalMessage('  IMPORTANT: Make sure Switch A (SwA) is DOWN (1000) on your transmitter to allow PID changes');
            addTerminalMessage(' Switch A UP (2000) = Flight mode, Switch A DOWN (1000) = PID tuning mode');
            
            await sendPID(type);
        }
        
        async function requestPID(type) {
            try {
                const response = await fetch('/api/request_pid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    addTerminalMessage(`Requested PID gains type ${type}`);
                } else {
                    addTerminalMessage(`Failed to request PID: ${result.message}`);
                }
            } catch (error) {
                console.error('Request PID error:', error);
                addTerminalMessage('Failed to request PID gains');
            }
        }
        
        async function requestAllPID() {
            await requestPID(6);
        }
        
        // Function to fetch and update PID gains from FC
        async function fetchPIDGains() {
            try {
                const response = await fetch('/api/pid_gains');
                const result = await response.json();
                
                if (result.status === 'success' && result.pid_gains) {
                    // Update received PID gains display
                    updateReceivedPIDGains(result.pid_gains);
                }
            } catch (error) {
                console.error('Fetch PID gains error:', error);
            }
        }
        
        // Function to update received PID gains display
        function updateReceivedPIDGains(pidGains) {
            const gainTypes = {
                'roll_inner': 'rollInnerReceived',
                'roll_outer': 'rollOuterReceived', 
                'pitch_inner': 'pitchInnerReceived',
                'pitch_outer': 'pitchOuterReceived',
                'yaw_angle': 'yawAngleReceived',
                'yaw_rate': 'yawRateReceived'
            };
            
            for (const [type, elementId] of Object.entries(gainTypes)) {
                if (pidGains[type]) {
                    const p = pidGains[type].p || 0;
                    const i = pidGains[type].i || 0;
                    const d = pidGains[type].d || 0;
                    
                    // Update the received PID input fields
                    const pInput = document.getElementById(elementId + 'P');
                    const iInput = document.getElementById(elementId + 'I');
                    const dInput = document.getElementById(elementId + 'D');
                    
                    if (pInput) pInput.value = p.toFixed(3);
                    if (iInput) iInput.value = i.toFixed(3);
                    if (dInput) dInput.value = d.toFixed(3);
                }
            }
        }
        
        // Start periodic PID gains fetching
        setInterval(fetchPIDGains, 1000); // Fetch every second
        
        // Function to update switch status display
        function updateSwitchStatus(swaValue) {
            const statusElement = document.getElementById('switchAStatus');
            if (statusElement) {
                if (swaValue === 0) {
                    statusElement.textContent = 'DOWN (1000) - PID Tuning Mode ';
                    statusElement.className = 'switch-value ready';
                } else if (swaValue === 1) {
                    statusElement.textContent = 'UP (2000) - Flight Mode ';
                    statusElement.className = 'switch-value not-ready';
                } else {
                    statusElement.textContent = `Unknown (${swaValue}) `;
                    statusElement.className = 'switch-value';
                }
            }
        }
        
        // Function to fetch and update real-time flight data
        async function fetchFlightData() {
            try {
                const response = await fetch('/api/flight_data');
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    // Update AHRS data display
                    updateAHRSDisplay(result.data);
                    
                    // Update switch status if available
                    if (result.data.switches && result.data.switches.swa !== undefined) {
                        console.log('Switch A value received:', result.data.switches.swa);
                        updateSwitchStatus(result.data.switches.swa);
                    } else {
                        console.log('No switch data available in flight data:', result.data);
                    }
                }
            } catch (error) {
                console.error('Fetch flight data error:', error);
            }
        }
        
        function updateSystemStatus(data) {
            // Update telemetry dashboard with real system status data
            if (data.data_rate_ahrs !== undefined) {
                telemetryStats.ahrsRate = data.data_rate_ahrs;
            }
            if (data.data_rate_gps !== undefined) {
                telemetryStats.gpsRate = data.data_rate_gps;
            }
            if (data.connection_quality !== undefined) {
                telemetryStats.connectionQuality = data.connection_quality;
            }
            
            // Update UI immediately
            updateTelemetryUI();
        }
        
        function updateFlightData(data) {
            // Update flight data displays
            if (data.roll_angle !== undefined) {
                document.getElementById('rollAngle').textContent = data.roll_angle.toFixed(2) + '';
            }
            if (data.pitch_angle !== undefined) {
                document.getElementById('pitchAngle').textContent = data.pitch_angle.toFixed(2) + '';
            }
            if (data.yaw_angle !== undefined) {
                document.getElementById('yawAngle').textContent = data.yaw_angle.toFixed(2) + '';
            }
            if (data.barometric_altitude !== undefined) {
                document.getElementById('altitude').textContent = data.barometric_altitude.toFixed(1) + 'm';
            }
            
            // Update flight instruments
            updateFlightInstruments(data);
        }
        
        function updateNavigationData(data) {
            // Update navigation displays
            if (data.gps_latitude !== undefined) {
                document.getElementById('latitude').textContent = data.gps_latitude.toFixed(6) + '';
            }
            if (data.gps_longitude !== undefined) {
                document.getElementById('longitude').textContent = data.gps_longitude.toFixed(6) + '';
            }
            if (data.gps_altitude !== undefined) {
                document.getElementById('altitude').textContent = data.gps_altitude.toFixed(1) + 'm';
            }
        }
        
        function updatePowerSystem(data) {
            // Update power system displays
            if (data.battery_voltage !== undefined) {
                document.getElementById('batteryVoltage').textContent = data.battery_voltage.toFixed(1) + 'V';
                updateBatteryStatus(data.battery_voltage);
            }
            if (data.battery_percentage !== undefined) {
                document.getElementById('batteryPercentage').textContent = data.battery_percentage.toFixed(0) + '%';
            }
        }
        
        function updateRemoteControl(data) {
            // Update remote control displays
            if (data.ibus_swa !== undefined) {
                updateSwitchStatus(data.ibus_swa, data.ibus_swc, data.failsafe_status);
            }
        }

        // Function to update AHRS display
        function updateAHRSDisplay(data) {
            // Update roll, pitch, yaw values
            if (data.roll_angle !== undefined) {
                const rollElement = document.getElementById('rollAngle');
                if (rollElement) rollElement.textContent = data.roll_angle.toFixed(2);
            }
            if (data.pitch_angle !== undefined) {
                const pitchElement = document.getElementById('pitchAngle');
                if (pitchElement) pitchElement.textContent = data.pitch_angle.toFixed(2);
            }
            if (data.yaw_angle !== undefined) {
                const yawElement = document.getElementById('yawAngle');
                if (yawElement) yawElement.textContent = data.yaw_angle.toFixed(2);
            }
            if (data.barometric_altitude !== undefined) {
                const altElement = document.getElementById('altitude');
                if (altElement) altElement.textContent = data.barometric_altitude.toFixed(1);
            }

            // Update battery voltage
            if (data.battery_voltage !== undefined) {
                const batteryElement = document.getElementById('batteryVoltage');
                if (batteryElement) batteryElement.textContent = data.battery_voltage.toFixed(1) + 'V';
            }

            // Update connection status
            if (data.connection_status) {
                const statusElement = document.getElementById('statusText');
                if (statusElement) statusElement.textContent = data.connection_status;
            }
            
            // Update flight instruments
            updateFlightInstruments(data);
        }
        
        // Start periodic flight data fetching
        setInterval(fetchFlightData, 100); // Fetch every 100ms for real-time updates
        
        async function sendTerminal() {
            const input = document.getElementById('terminalInput');
            const mode = document.getElementById('terminalMode').value;
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const response = await fetch('/api/send_terminal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message, mode })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    addTerminalMessage(`Sent (${mode}): ${message}`);
                    input.value = '';
                } else {
                    addTerminalMessage(`Failed to send: ${result.message}`);
                }
            } catch (error) {
                console.error('Terminal send error:', error);
                addTerminalMessage('Failed to send message');
            }
        }
        
        function addTerminalMessage(message) {
            const output = document.getElementById('terminalOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `[${timestamp}] ${message}<br>`;
            output.scrollTop = output.scrollHeight;
        }
        
        // Terminal input enter key
        document.getElementById('terminalInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendTerminal();
            }
        });
        
        // Flight Indicators Implementation
        let flightInstruments = {};
        let dataUpdateCount = 0;
        let lastDataTime = Date.now();
        
        // Initialize flight instruments when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeFlightInstruments();
        });
        
        function initializeFlightInstruments() {
            // Create flight indicators using the jQuery plugin
            if (typeof $.flightIndicator !== 'undefined') {
                flightInstruments.attitude = $.flightIndicator('#attitude-instrument', 'attitude', {
                    size: 200,
                    roll: 0,
                    pitch: 0,
                    showBox: true,
                    img_directory: '/static/img/'
                });
                
                flightInstruments.heading = $.flightIndicator('#heading-instrument', 'heading', {
                    size: 200,
                    heading: 0,
                    showBox: true,
                    img_directory: '/static/img/'
                });
                
                flightInstruments.altimeter = $.flightIndicator('#altitude-instrument', 'altimeter', {
                    size: 200,
                    altitude: 0,
                    pressure: 1013.25,
                    showBox: true,
                    img_directory: '/static/img/'
                });
                
                flightInstruments.airspeed = $.flightIndicator('#speed-instrument', 'airspeed', {
                    size: 200,
                    airspeed: 0,
                    showBox: true,
                    img_directory: '/static/img/'
                });
                
                flightInstruments.variometer = $.flightIndicator('#vario-instrument', 'variometer', {
                    size: 200,
                    vario: 0,
                    showBox: true,
                    img_directory: '/static/img/'
                });
                
                flightInstruments.turnCoordinator = $.flightIndicator('#turn-instrument', 'turn_coordinator', {
                    size: 200,
                    turn: 0,
                    showBox: true,
                    img_directory: '/static/img/'
                });
                
                console.log('Flight instruments initialized');
            } else {
                console.error('Flight indicators plugin not loaded');
                // Fallback: Create simple displays
                createSimpleInstruments();
            }
        }
        
        function createSimpleInstruments() {
            // Fallback implementation if jQuery plugin is not available
            console.log('Creating simple instrument displays');
            
            // Create simple circular displays for each instrument
            const instruments = ['attitude', 'heading', 'altitude', 'speed', 'vario', 'turn'];
            
            instruments.forEach(function(instrument) {
                const container = document.getElementById(instrument + '-instrument');
                if (container) {
                    container.innerHTML = `
                        <div class="simple-instrument" style="
                            width: 200px; 
                            height: 200px; 
                            border: 3px solid #34495e; 
                            border-radius: 50%; 
                            margin: 0 auto; 
                            position: relative; 
                            background: linear-gradient(45deg, #ecf0f1, #bdc3c7);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 24px;
                            font-weight: bold;
                            color: #2c3e50;
                        ">
                            <div class="instrument-value ${instrument}">0.0</div>
                        </div>
                    `;
                }
            });
        }
        
        
        // Enhanced AHRS data update function
        function updateAHRSData(data) {
            // Original AHRS update
            document.getElementById('rollAngle').textContent = data.roll_angle.toFixed(2);
            document.getElementById('pitchAngle').textContent = data.pitch_angle.toFixed(2);
            document.getElementById('yawAngle').textContent = data.yaw_angle.toFixed(2);
            document.getElementById('altitude').textContent = data.altitude.toFixed(1);
            
            // Update flight instruments
            updateFlightInstruments(data);
            
            // Update real-time graphs
            updateCharts(data);
        }
        
        // Function to update flight instruments with new data
        function updateFlightInstruments(data) {
            if (typeof flightInstruments === 'undefined' || Object.keys(flightInstruments).length === 0) {
                console.log('Flight instruments not initialized yet');
                return;
            }
            
            try {
                // Update attitude indicator
                if (flightInstruments.attitude && data.roll_angle !== undefined && data.pitch_angle !== undefined) {
                    flightInstruments.attitude.setRoll(data.roll_angle);
                    flightInstruments.attitude.setPitch(data.pitch_angle);
                }
                
                // Update heading indicator
                if (flightInstruments.heading && data.yaw_angle !== undefined) {
                    flightInstruments.heading.setHeading(data.yaw_angle);
                }
                
                // Update altimeter
                if (flightInstruments.altimeter && data.altitude !== undefined) {
                    flightInstruments.altimeter.setAltitude(data.altitude);
                }
                
                // Update airspeed (if available in data)
                if (flightInstruments.airspeed && data.airspeed !== undefined) {
                    flightInstruments.airspeed.setAirspeed(data.airspeed);
                } else if (flightInstruments.airspeed) {
                    // Use ground speed as fallback
                    flightInstruments.airspeed.setAirspeed(data.ground_speed || 0);
                }
                
                // Update variometer (if available in data)
                if (flightInstruments.variometer && data.vertical_speed !== undefined) {
                    flightInstruments.variometer.setVario(data.vertical_speed);
                } else if (flightInstruments.variometer) {
                    // Calculate vertical speed from altitude change
                    flightInstruments.variometer.setVario(0); // Default to 0 if no data
                }
                
                // Update turn coordinator (if available in data)
                if (flightInstruments.turnCoordinator && data.turn_rate !== undefined) {
                    flightInstruments.turnCoordinator.setTurn(data.turn_rate);
                } else if (flightInstruments.turnCoordinator) {
                    // Use roll angle as turn indicator
                    flightInstruments.turnCoordinator.setTurn(data.roll_angle || 0);
                }
                
            } catch (error) {
                console.error('Error updating flight instruments:', error);
            }
        }

        // Chart.js Charts Implementation
        let charts = {};
        let chartData = {
            attitude: { labels: [], roll: [], pitch: [], yaw: [] },
            altitudeSpeed: { labels: [], altitude: [], speed: [] },
            batteryVario: { labels: [], battery: [], vario: [] },
            gps: { labels: [], latitude: [], longitude: [] },
            ahrsMini: { labels: [], roll: [], pitch: [], yaw: [] }
        };
        let maxDataPoints = 100; // Maximum number of data points to show

        // Initialize charts when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            
            // Handle window resize to maintain crisp rendering
            window.addEventListener('resize', function() {
                setTimeout(() => {
                    const chartCanvases = [
                        'attitudeChart', 'altitudeSpeedChart', 'batteryVarioChart', 'gpsChart', 'ahrsMiniChart'
                    ];
                    
                    chartCanvases.forEach(canvasId => {
                        const canvas = document.getElementById(canvasId);
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            const dpr = window.devicePixelRatio || 1;
                            const rect = canvas.getBoundingClientRect();
                            
                            canvas.width = rect.width * dpr;
                            canvas.height = rect.height * dpr;
                            ctx.scale(dpr, dpr);
                            canvas.style.width = rect.width + 'px';
                            canvas.style.height = rect.height + 'px';
                        }
                    });
                    
                    // Resize all charts
                    Object.values(charts).forEach(chart => {
                        if (chart) {
                            chart.resize();
                        }
                    });
                }, 100);
            });
        });

        function initializeCharts() {
            // Fix canvas blurriness by setting device pixel ratio
            function setupCanvas(canvas) {
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
            }

            // Setup all chart canvases
            const chartCanvases = [
                'attitudeChart', 'altitudeSpeedChart', 'batteryVarioChart', 'gpsChart', 'ahrsMiniChart'
            ];
            
            chartCanvases.forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    setupCanvas(canvas);
                }
            });

            // Attitude Chart (Roll, Pitch, Yaw)
            const attitudeCtx = document.getElementById('attitudeChart').getContext('2d');
            charts.attitude = new Chart(attitudeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Roll ()',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            fill: false,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            showPoints: false
                        },
                        {
                            label: 'Pitch ()',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: false,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            showPoints: false
                        },
                        {
                            label: 'Yaw ()',
                            data: [],
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4,
                            fill: false,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            showPoints: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    elements: {
                        point: {
                            radius: 0,
                            hoverRadius: 0
                        },
                        line: {
                            borderWidth: 2
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    },
                    onClick: function(event, elements) {
                        // Double-click detection
                        if (event.native.detail === 2) {
                            toggleDataPoints('attitude');
                        }
                    }
                }
            });

            // Altitude & Speed Chart
            const altitudeSpeedCtx = document.getElementById('altitudeSpeedChart').getContext('2d');
            charts.altitudeSpeed = new Chart(altitudeSpeedCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Altitude (m)',
                            data: [],
                            borderColor: '#9b59b6',
                            backgroundColor: 'rgba(155, 89, 182, 0.1)',
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y',
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            showPoints: false
                        },
                        {
                            label: 'Speed (m/s)',
                            data: [],
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1',
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            showPoints: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    onClick: function(event, elements) {
                        // Double-click detection
                        if (event.native.detail === 2) {
                            toggleDataPoints('altitudeSpeed');
                        }
                    }
                }
            });

            // Battery & Vario Chart
            const batteryVarioCtx = document.getElementById('batteryVarioChart').getContext('2d');
            charts.batteryVario = new Chart(batteryVarioCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Battery (V)',
                            data: [],
                            borderColor: '#e67e22',
                            backgroundColor: 'rgba(230, 126, 34, 0.1)',
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y',
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            showPoints: false
                        },
                        {
                            label: 'Vertical Speed (m/s)',
                            data: [],
                            borderColor: '#1abc9c',
                            backgroundColor: 'rgba(26, 188, 156, 0.1)',
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1',
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            showPoints: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    onClick: function(event, elements) {
                        // Double-click detection
                        if (event.native.detail === 2) {
                            toggleDataPoints('batteryVario');
                        }
                    }
                }
            });

            // GPS Chart
            const gpsCtx = document.getElementById('gpsChart').getContext('2d');
            charts.gps = new Chart(gpsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Latitude',
                            data: [],
                            borderColor: '#34495e',
                            backgroundColor: 'rgba(52, 73, 94, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            showPoints: false
                        },
                        {
                            label: 'Longitude',
                            data: [],
                            borderColor: '#95a5a6',
                            backgroundColor: 'rgba(149, 165, 166, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            showPoints: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    onClick: function(event, elements) {
                        // Double-click detection
                        if (event.native.detail === 2) {
                            toggleDataPoints('gps');
                        }
                    }
                }
            });

            // Mini AHRS Chart for AHRS panel
            const ahrsMiniCtx = document.getElementById('ahrsMiniChart').getContext('2d');
            charts.ahrsMini = new Chart(ahrsMiniCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Roll ()',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            showPoints: false
                        },
                        {
                            label: 'Pitch ()',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            showPoints: false
                        },
                        {
                            label: 'Yaw ()',
                            data: [],
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            showPoints: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            display: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    onClick: function(event, elements) {
                        // Double-click detection
                        if (event.native.detail === 2) {
                            toggleDataPoints('ahrsMini');
                        }
                    }
                }
            });

            console.log('Charts initialized');
        }

        // Function to toggle data points visibility on double-click
        function toggleDataPoints(chartName) {
            const chart = charts[chartName];
            if (!chart) return;
            
            // Toggle point visibility for all datasets
            chart.data.datasets.forEach(dataset => {
                if (dataset.showPoints === false) {
                    // Show points
                    dataset.pointRadius = 3;
                    dataset.pointHoverRadius = 5;
                    dataset.showPoints = true;
                } else {
                    // Hide points
                    dataset.pointRadius = 0;
                    dataset.pointHoverRadius = 0;
                    dataset.showPoints = false;
                }
            });
            
            // Update the chart
            chart.update('none');
            
            // Show notification
            const status = chart.data.datasets[0].showPoints ? 'shown' : 'hidden';
            addTerminalMessage(` Data points ${status} for ${chartName} chart`);
        }

        function updateCharts(data) {
            const timestamp = new Date().toLocaleTimeString();
            
            // Update attitude chart data
            if (data.roll_angle !== undefined && data.pitch_angle !== undefined && data.yaw_angle !== undefined) {
                chartData.attitude.labels.push(timestamp);
                chartData.attitude.roll.push(data.roll_angle);
                chartData.attitude.pitch.push(data.pitch_angle);
                chartData.attitude.yaw.push(data.yaw_angle);
                
                // Limit data points
                if (chartData.attitude.labels.length > maxDataPoints) {
                    chartData.attitude.labels.shift();
                    chartData.attitude.roll.shift();
                    chartData.attitude.pitch.shift();
                    chartData.attitude.yaw.shift();
                }
                
                charts.attitude.data.labels = chartData.attitude.labels;
                charts.attitude.data.datasets[0].data = chartData.attitude.roll;
                charts.attitude.data.datasets[1].data = chartData.attitude.pitch;
                charts.attitude.data.datasets[2].data = chartData.attitude.yaw;
                charts.attitude.update('none');

                // Update mini AHRS chart
                chartData.ahrsMini.labels.push(timestamp);
                chartData.ahrsMini.roll.push(data.roll_angle);
                chartData.ahrsMini.pitch.push(data.pitch_angle);
                chartData.ahrsMini.yaw.push(data.yaw_angle);
                
                // Limit data points for mini chart (shorter history)
                if (chartData.ahrsMini.labels.length > 30) {
                    chartData.ahrsMini.labels.shift();
                    chartData.ahrsMini.roll.shift();
                    chartData.ahrsMini.pitch.shift();
                    chartData.ahrsMini.yaw.shift();
                }
                
                charts.ahrsMini.data.labels = chartData.ahrsMini.labels;
                charts.ahrsMini.data.datasets[0].data = chartData.ahrsMini.roll;
                charts.ahrsMini.data.datasets[1].data = chartData.ahrsMini.pitch;
                charts.ahrsMini.data.datasets[2].data = chartData.ahrsMini.yaw;
                charts.ahrsMini.update('none');
            }
            
            // Update altitude & speed chart data
            if (data.altitude !== undefined) {
                chartData.altitudeSpeed.labels.push(timestamp);
                chartData.altitudeSpeed.altitude.push(data.altitude);
                
                // Calculate speed from GPS or use estimated
                let speed = 0;
                if (data.gps_speed !== undefined) {
                    speed = data.gps_speed;
                } else if (data.estimated_speed !== undefined) {
                    speed = data.estimated_speed;
                }
                chartData.altitudeSpeed.speed.push(speed);
                
                // Limit data points
                if (chartData.altitudeSpeed.labels.length > maxDataPoints) {
                    chartData.altitudeSpeed.labels.shift();
                    chartData.altitudeSpeed.altitude.shift();
                    chartData.altitudeSpeed.speed.shift();
                }
                
                charts.altitudeSpeed.data.labels = chartData.altitudeSpeed.labels;
                charts.altitudeSpeed.data.datasets[0].data = chartData.altitudeSpeed.altitude;
                charts.altitudeSpeed.data.datasets[1].data = chartData.altitudeSpeed.speed;
                charts.altitudeSpeed.update('none');
            }
            
            // Update battery & vario chart data
            if (data.battery_voltage !== undefined) {
                chartData.batteryVario.labels.push(timestamp);
                chartData.batteryVario.battery.push(data.battery_voltage);
                
                // Calculate vertical speed
                let vario = 0;
                if (data.vertical_speed !== undefined) {
                    vario = data.vertical_speed;
                }
                chartData.batteryVario.vario.push(vario);
                
                // Limit data points
                if (chartData.batteryVario.labels.length > maxDataPoints) {
                    chartData.batteryVario.labels.shift();
                    chartData.batteryVario.battery.shift();
                    chartData.batteryVario.vario.shift();
                }
                
                charts.batteryVario.data.labels = chartData.batteryVario.labels;
                charts.batteryVario.data.datasets[0].data = chartData.batteryVario.battery;
                charts.batteryVario.data.datasets[1].data = chartData.batteryVario.vario;
                charts.batteryVario.update('none');
            }
            
            // Update GPS chart data
            if (data.latitude !== undefined && data.longitude !== undefined) {
                chartData.gps.labels.push(timestamp);
                chartData.gps.latitude.push(data.latitude);
                chartData.gps.longitude.push(data.longitude);
                
                // Limit data points
                if (chartData.gps.labels.length > maxDataPoints) {
                    chartData.gps.labels.shift();
                    chartData.gps.latitude.shift();
                    chartData.gps.longitude.shift();
                }
                
                charts.gps.data.labels = chartData.gps.labels;
                charts.gps.data.datasets[0].data = chartData.gps.latitude;
                charts.gps.data.datasets[1].data = chartData.gps.longitude;
                charts.gps.update('none');
            }
        }

        // Chart control functions
        function toggleGraph(chartType, dataType) {
            const button = event.target;
            const chart = charts[chartType];
            
            if (button.classList.contains('active')) {
                button.classList.remove('active');
                // Hide dataset
                const datasetIndex = getDatasetIndex(chartType, dataType);
                if (datasetIndex !== -1) {
                    chart.data.datasets[datasetIndex].hidden = true;
                    chart.update('none');
                }
            } else {
                button.classList.add('active');
                // Show dataset
                const datasetIndex = getDatasetIndex(chartType, dataType);
                if (datasetIndex !== -1) {
                    chart.data.datasets[datasetIndex].hidden = false;
                    chart.update('none');
                }
            }
        }

        function clearGraph(chartType) {
            const chart = charts[chartType];
            const chartDataKey = chartType;
            
            // Clear data arrays
            Object.keys(chartData[chartDataKey]).forEach(key => {
                if (Array.isArray(chartData[chartDataKey][key])) {
                    chartData[chartDataKey][key] = [];
                }
            });
            
            // Clear chart
            chart.data.labels = [];
            chart.data.datasets.forEach(dataset => {
                dataset.data = [];
            });
            chart.update('none');
        }

        function getDatasetIndex(chartType, dataType) {
            const chartTypeMap = {
                'attitude': { 'roll': 0, 'pitch': 1, 'yaw': 2 },
                'altitudeSpeed': { 'altitude': 0, 'speed': 1 },
                'batteryVario': { 'battery': 0, 'vario': 1 },
                'gps': { 'latitude': 0, 'longitude': 1 }
            };
            
            return chartTypeMap[chartType]?.[dataType] ?? -1;
        }
        
        // Mission Planning Variables
        let waypoints = [];
        let currentFlightMode = 'MANUAL';
        let missionStats = {
            totalWaypoints: 0,
            totalDistance: 0,
            estimatedTime: 0,
            status: 'Ready'
        };

        // HUD Variables
        let hudData = {
            pitch: 0,
            roll: 0,
            yaw: 0,
            altitude: 0,
            airspeed: 0,
            heading: 0,
            verticalSpeed: 0,
            flightMode: 'MANUAL',
            gpsStatus: 'No Fix',
            batteryVoltage: 0
        };

        // Mission Planning Functions
        function setFlightMode(mode) {
            currentFlightMode = mode;
            
            // Update UI
            document.getElementById('currentFlightMode').textContent = mode;
            document.getElementById('hudFlightMode').textContent = mode;
            
            // Remove active class from all buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to selected button
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // Send to flight controller
            sendFlightModeCommand(mode);
            
            addTerminalMessage(`Flight mode changed to: ${mode}`);
        }

        async function sendFlightModeCommand(mode) {
            try {
                const response = await fetch('/api/set_flight_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mode: mode })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    addTerminalMessage(` Flight mode ${mode} sent successfully`);
                } else {
                    addTerminalMessage(` Failed to set flight mode: ${result.message}`);
                }
            } catch (error) {
                console.error('Flight mode error:', error);
                addTerminalMessage(` Flight mode command failed: ${error.message}`);
            }
        }

        function addWaypoint() {
            const lat = prompt('Enter Latitude:', '37.7749');
            const lng = prompt('Enter Longitude:', '-122.4194');
            const alt = prompt('Enter Altitude (meters):', '100');
            const type = prompt('Enter Waypoint Type (WAYPOINT, TAKEOFF, LAND, RTL):', 'WAYPOINT');
            
            if (lat && lng && alt) {
                const waypoint = {
                    id: waypoints.length + 1,
                    latitude: parseFloat(lat),
                    longitude: parseFloat(lng),
                    altitude: parseFloat(alt),
                    type: type.toUpperCase()
                };
                
                waypoints.push(waypoint);
                updateWaypointTable();
                updateMissionStats();
                
                addTerminalMessage(`Waypoint ${waypoint.id} added: ${lat}, ${lng}, ${alt}m`);
            }
        }

        function updateWaypointTable() {
            const tbody = document.getElementById('waypointTableBody');
            tbody.innerHTML = '';
            
            waypoints.forEach(wp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${wp.id}</td>
                    <td>${wp.latitude.toFixed(6)}</td>
                    <td>${wp.longitude.toFixed(6)}</td>
                    <td>${wp.altitude}m</td>
                    <td>${wp.type}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeWaypoint(${wp.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function removeWaypoint(id) {
            waypoints = waypoints.filter(wp => wp.id !== id);
            updateWaypointTable();
            updateMissionStats();
            addTerminalMessage(`Waypoint ${id} removed`);
        }

        function updateMissionStats() {
            missionStats.totalWaypoints = waypoints.length;
            
            // Calculate total distance
            let totalDistance = 0;
            for (let i = 1; i < waypoints.length; i++) {
                const prev = waypoints[i - 1];
                const curr = waypoints[i];
                const distance = calculateDistance(prev.latitude, prev.longitude, curr.latitude, curr.longitude);
                totalDistance += distance;
            }
            
            missionStats.totalDistance = totalDistance;
            missionStats.estimatedTime = Math.round(totalDistance / 10); // Assume 10 m/s average speed
            
            // Update UI
            document.getElementById('totalWaypoints').textContent = missionStats.totalWaypoints;
            document.getElementById('totalDistance').textContent = `${totalDistance.toFixed(1)} m`;
            document.getElementById('estimatedTime').textContent = `${Math.floor(missionStats.estimatedTime / 60)}:${(missionStats.estimatedTime % 60).toString().padStart(2, '0')}`;
            document.getElementById('missionStatus').textContent = waypoints.length > 0 ? 'Ready' : 'Empty';
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function uploadMission() {
            if (waypoints.length === 0) {
                alert('No waypoints to upload');
                return;
            }
            
            try {
                const response = await fetch('/api/upload_mission', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ waypoints: waypoints })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    addTerminalMessage(` Mission uploaded successfully (${waypoints.length} waypoints)`);
                    document.getElementById('missionStatus').textContent = 'Uploaded';
                } else {
                    addTerminalMessage(` Mission upload failed: ${result.message}`);
                }
            } catch (error) {
                console.error('Mission upload error:', error);
                addTerminalMessage(` Mission upload failed: ${error.message}`);
            }
        }

        async function downloadMission() {
            try {
                const response = await fetch('/api/download_mission');
                const result = await response.json();
                
                if (result.status === 'success' && result.waypoints) {
                    waypoints = result.waypoints;
                    updateWaypointTable();
                    updateMissionStats();
                    addTerminalMessage(` Mission downloaded (${waypoints.length} waypoints)`);
                } else {
                    addTerminalMessage(` Mission download failed: ${result.message}`);
                }
            } catch (error) {
                console.error('Mission download error:', error);
                addTerminalMessage(` Mission download failed: ${error.message}`);
            }
        }

        function clearMission() {
            if (confirm('Are you sure you want to clear all waypoints?')) {
                waypoints = [];
                updateWaypointTable();
                updateMissionStats();
                addTerminalMessage('Mission cleared');
            }
        }

        // Professional HUD Canvas Implementation
        let hudCanvas = null;
        let hudCtx = null;
        let hudInitialized = false;

        // Initialize Professional HUD Canvas
        function initializeProfessionalHUD() {
            hudCanvas = document.getElementById('hudCanvas');
            if (!hudCanvas) return;
            
            hudCtx = hudCanvas.getContext('2d');
            hudInitialized = true;
            
            // Set canvas size to match container
            const container = hudCanvas.parentElement;
            hudCanvas.width = container.offsetWidth;
            hudCanvas.height = container.offsetHeight;
            
            // Start HUD drawing loop
            drawProfessionalHUD();
        }

        // Professional HUD Drawing Function (MissionPlanner Style)
        function drawProfessionalHUD() {
            if (!hudInitialized || !hudCtx) return;
            
            const canvas = hudCanvas;
            const ctx = hudCtx;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Save context
            ctx.save();
            
            // Translate to center
            ctx.translate(canvas.width / 2, canvas.height / 2);
            
            // Apply roll rotation
            ctx.rotate(-hudData.roll * Math.PI / 180);
            
            // Create MissionPlanner-style gradient background
            const halfWidth = canvas.width / 2;
            const halfHeight = canvas.height / 2;
            const every5deg = -canvas.height / 60;
            const pitchOffset = -hudData.pitch * every5deg;
            
            // Create dynamic gradient based on pitch
            const gradObj = ctx.createLinearGradient(0, -halfHeight * 2, 0, halfHeight * 2);
            gradObj.addColorStop(0.0, "#1e3c72"); // Dark blue sky
            let offset = 0.5 + pitchOffset / canvas.height / 2;
            if (offset < 0) offset = 0;
            if (offset > 1) offset = 1;
            gradObj.addColorStop(offset, "#87ceeb"); // Light blue sky
            gradObj.addColorStop(offset, "#9bb824"); // Ground transition
            gradObj.addColorStop(1.0, "#414f07"); // Dark ground
            
            // Fill background with gradient
            ctx.fillStyle = gradObj;
            ctx.fillRect(-halfWidth * 2, -halfHeight * 2, halfWidth * 4, halfHeight * 4);
            
            // Draw pitch lines
            const lengthShort = canvas.width / 12;
            const lengthLong = canvas.width / 8;
            
            for (let a = -90; a <= 90; a += 5) {
                // Limit to visible range
                if (a >= hudData.pitch - 34 && a <= hudData.pitch + 25) {
                    if (a % 10 == 0) {
                        // Major pitch lines
                        ctx.strokeStyle = "white";
                        ctx.lineWidth = 4;
                        ctx.beginPath();
                        ctx.moveTo(-lengthLong, pitchOffset + a * every5deg);
                        ctx.lineTo(lengthLong, pitchOffset + a * every5deg);
                        ctx.stroke();
                        
                        // Draw pitch angle numbers
                        ctx.fillStyle = "white";
                        ctx.font = `${canvas.height / 30}pt Arial`;
                        ctx.textAlign = "right";
                        ctx.fillText(a.toString(), -lengthLong - 30, pitchOffset + a * every5deg + 8);
                    } else {
                        // Minor pitch lines
                        ctx.strokeStyle = "white";
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(-lengthShort, pitchOffset + a * every5deg);
                        ctx.lineTo(lengthShort, pitchOffset + a * every5deg);
                        ctx.stroke();
                    }
                }
            }
            
            // Draw aircraft symbol (center crosshair)
            ctx.restore();
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            
            // Main crosshair
            ctx.strokeStyle = "#00ff00";
            ctx.lineWidth = 3;
            ctx.beginPath();
            // Horizontal line
            ctx.moveTo(-20, 0);
            ctx.lineTo(20, 0);
            // Vertical line
            ctx.moveTo(0, -20);
            ctx.lineTo(0, 20);
            ctx.stroke();
            
            // Aircraft nose indicator
            ctx.strokeStyle = "#ff0000";
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(0, -30);
            ctx.lineTo(-10, -20);
            ctx.lineTo(10, -20);
            ctx.closePath();
            ctx.stroke();
            
            // Draw roll scale
            const rollScaleLength = canvas.height / 66;
            const extra = canvas.height / 15 * 4.9;
            
            for (let a = -60; a <= 60; a += 15) {
                ctx.restore();
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(a * Math.PI / 180);
                
                // Roll scale lines
                ctx.strokeStyle = "white";
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, -rollScaleLength * 3 - extra);
                ctx.lineTo(0, -rollScaleLength * 3 - extra - rollScaleLength);
                ctx.stroke();
                
                // Roll angle numbers
                ctx.fillStyle = "white";
                ctx.font = `${canvas.height / 30}pt Arial`;
                ctx.textAlign = "center";
                ctx.fillText(a.toString(), 0, -rollScaleLength * 8 - extra + 10);
            }
            
            ctx.restore();
            
            // Schedule next frame
            requestAnimationFrame(drawProfessionalHUD);
        }

        // HUD Functions
        function updateHUD(data) {
            // Update HUD data
            hudData.pitch = data.pitch_angle || 0;
            hudData.roll = data.roll_angle || 0;
            hudData.yaw = data.yaw_angle || 0;
            hudData.altitude = data.altitude || 0;
            hudData.airspeed = data.speed || 0;
            hudData.heading = data.yaw_angle || 0;
            hudData.verticalSpeed = data.vertical_speed || 0;
            hudData.batteryVoltage = data.battery_voltage || 0;
            
            // Note: Artificial horizon is drawn by drawProfessionalHUD() canvas function
            // No need to call updateArtificialHorizon() as it looks for non-existent HTML elements
            
            // Update HUD displays
            document.getElementById('hudAltitude').textContent = Math.round(hudData.altitude);
            document.getElementById('hudAirspeed').textContent = Math.round(hudData.airspeed);
            document.getElementById('hudHeading').textContent = Math.round(hudData.heading).toString().padStart(3, '0') + '';
            document.getElementById('hudVerticalSpeed').textContent = hudData.verticalSpeed.toFixed(1);
            document.getElementById('hudBatteryStatus').textContent = `BAT: ${hudData.batteryVoltage.toFixed(1)}V`;
            
            // Update GPS status
            const gpsStatus = data.gps_fix ? 'GPS: Fix' : 'GPS: No Fix';
            document.getElementById('hudGpsStatus').textContent = gpsStatus;
        }

        // Enhanced data update functions
        function updateAHRSData(data) {
            // Original AHRS update
            document.getElementById('rollAngle').textContent = data.roll_angle.toFixed(2) + '';
            document.getElementById('pitchAngle').textContent = data.pitch_angle.toFixed(2) + '';
            document.getElementById('yawAngle').textContent = data.yaw_angle.toFixed(2) + '';
            document.getElementById('altitude').textContent = data.altitude.toFixed(1) + 'm';
            
            // Update HUD
            updateHUD(data);
            
            // Update flight instruments
            updateFlightInstruments(data);
            
            // Update real-time graphs
            updateCharts(data);
        }

        // Initialize
        refreshPorts();
        addTerminalMessage('KMU Ground Station initialized');
        addTerminalMessage('Mission Planning and Professional HUD loaded');

        // ===== ADVANCED VISUALIZATION FEATURES =====
        
        // Multi-Series Chart Implementation
        let multiSeriesChart = null;
        let multiSeriesData = {
            attitude: { roll: [], pitch: [], yaw: [] },
            navigation: { lat: [], lon: [], alt: [] },
            power: { voltage: [], current: [], percentage: [] },
            pid: { roll_p: [], pitch_p: [], yaw_p: [] }
        };
        let multiSeriesLabels = [];
        let maxMultiSeriesPoints = 200;

        // Spectrogram Implementation
        let spectrogramCanvas = null;
        let spectrogramCtx = null;
        let spectrogramData = [];
        let spectrogramRunning = false;
        let spectrogramInterval = null;
        let fftBuffer = [];
        let fftSize = 1024;

        // Cesium 3D Visualization
        let viewer = null;
        let aircraftEntity = null;
        let flightPathEntity = null;
        let waypointEntities = [];
        let terrainEnabled = true;
        let flightPathVisible = true;
        let waypointsVisible = false;
        let obstaclesVisible = false;
        let cameraMode = 'follow'; // 'follow', 'free', 'cockpit'

        // Log Analysis
        let logAnalysisChart = null;
        let loadedLogFiles = [];
        let analysisResults = {};

        // Initialize Advanced Charts
        function initializeAdvancedCharts() {
            // Multi-Series Chart
            const multiSeriesCtx = document.getElementById('multiSeriesChart').getContext('2d');
            multiSeriesChart = new Chart(multiSeriesCtx, {
                type: 'line',
                data: {
                    labels: multiSeriesLabels,
                    datasets: [
                        {
                            label: 'Roll',
                            data: multiSeriesData.attitude.roll,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1,
                            hidden: false
                        },
                        {
                            label: 'Pitch',
                            data: multiSeriesData.attitude.pitch,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.1,
                            hidden: false
                        },
                        {
                            label: 'Yaw',
                            data: multiSeriesData.attitude.yaw,
                            borderColor: 'rgb(255, 205, 86)',
                            backgroundColor: 'rgba(255, 205, 86, 0.2)',
                            tension: 0.1,
                            hidden: false
                        },
                        {
                            label: 'Battery Voltage',
                            data: multiSeriesData.power.voltage,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            hidden: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Attitude (degrees)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Voltage (V)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        },
                        legend: {
                            position: 'top',
                        }
                    }
                },
                plugins: [ChartZoom, ChartDataLabels]
            });

            // Initialize Spectrogram
            spectrogramCanvas = document.getElementById('spectrogramCanvas');
            spectrogramCtx = spectrogramCanvas.getContext('2d');
            initializeSpectrogram();

            // Initialize Cesium 3D Viewer
            initializeCesiumViewer();

            // Initialize Log Analysis Chart
            initializeLogAnalysisChart();
        }

        // Spectrogram Functions
        function initializeSpectrogram() {
            spectrogramCanvas.width = 800;
            spectrogramCanvas.height = 300;
            
            // Clear canvas with black background
            spectrogramCtx.fillStyle = '#000000';
            spectrogramCtx.fillRect(0, 0, spectrogramCanvas.width, spectrogramCanvas.height);
            
            // Draw frequency labels
            spectrogramCtx.fillStyle = '#ffffff';
            spectrogramCtx.font = '12px Arial';
            spectrogramCtx.fillText('Frequency (Hz)', 10, 20);
            spectrogramCtx.fillText('Time ', spectrogramCanvas.width - 60, spectrogramCanvas.height - 10);
        }

        function startSpectrogram() {
            if (spectrogramRunning) return;
            
            spectrogramRunning = true;
            spectrogramData = [];
            fftBuffer = [];
            
            spectrogramInterval = setInterval(() => {
                updateSpectrogram();
            }, 100); // Update every 100ms
            
            document.querySelector('.spectrogram-btn[onclick="startSpectrogram()"]').classList.add('active');
            document.querySelector('.spectrogram-btn[onclick="stopSpectrogram()"]').classList.remove('active');
        }

        function stopSpectrogram() {
            if (!spectrogramRunning) return;
            
            spectrogramRunning = false;
            clearInterval(spectrogramInterval);
            
            document.querySelector('.spectrogram-btn[onclick="startSpectrogram()"]').classList.remove('active');
            document.querySelector('.spectrogram-btn[onclick="stopSpectrogram()"]').classList.add('active');
        }

        function clearSpectrogram() {
            stopSpectrogram();
            spectrogramData = [];
            fftBuffer = [];
            initializeSpectrogram();
        }

        function updateSpectrogram() {
            if (!spectrogramRunning) return;
            
            // Get current sensor data based on selected source
            const source = document.getElementById('spectrogramSource').value;
            let sensorData = [];
            
            switch(source) {
                case 'gyro':
                    sensorData = [hudData.roll, hudData.pitch, hudData.yaw];
                    break;
                case 'accel':
                    sensorData = [Math.sin(hudData.roll), Math.cos(hudData.pitch), Math.sin(hudData.yaw)];
                    break;
                case 'mag':
                    sensorData = [Math.cos(hudData.roll), Math.sin(hudData.pitch), Math.cos(hudData.yaw)];
                    break;
                case 'pressure':
                    sensorData = [hudData.altitude / 100, hudData.verticalSpeed / 10, hudData.batteryVoltage];
                    break;
            }
            
            // Add to FFT buffer
            fftBuffer.push(...sensorData);
            
            // Keep buffer size manageable
            if (fftBuffer.length > fftSize) {
                fftBuffer = fftBuffer.slice(-fftSize);
            }
            
            // Perform FFT when we have enough data
            if (fftBuffer.length >= fftSize) {
                const fft = new FFT(fftSize);
                const spectrum = fft.createComplexArray();
                
                // Convert buffer to complex array
                for (let i = 0; i < fftSize; i++) {
                    spectrum[2 * i] = fftBuffer[i] || 0;
                    spectrum[2 * i + 1] = 0;
                }
                
                fft.fft(spectrum);
                
                // Extract magnitude spectrum
                const magnitudes = [];
                for (let i = 0; i < fftSize / 2; i++) {
                    const real = spectrum[2 * i];
                    const imag = spectrum[2 * i + 1];
                    magnitudes.push(Math.sqrt(real * real + imag * imag));
                }
                
                // Add to spectrogram data
                spectrogramData.push(magnitudes);
                
                // Keep only recent data
                if (spectrogramData.length > 200) {
                    spectrogramData.shift();
                }
                
                // Draw spectrogram
                drawSpectrogram();
            }
        }

        function drawSpectrogram() {
            if (spectrogramData.length === 0) return;
            
            // Clear canvas
            spectrogramCtx.fillStyle = '#000000';
            spectrogramCtx.fillRect(0, 0, spectrogramCanvas.width, spectrogramCanvas.height);
            
            const width = spectrogramCanvas.width;
            const height = spectrogramCanvas.height;
            const dataHeight = height - 40; // Leave space for labels
            
            // Draw spectrogram
            for (let t = 0; t < spectrogramData.length; t++) {
                const timeData = spectrogramData[t];
                const x = (t / spectrogramData.length) * width;
                
                for (let f = 0; f < timeData.length; f++) {
                    const magnitude = timeData[f];
                    const y = (f / timeData.length) * dataHeight;
                    
                    // Convert magnitude to color (hot colormap)
                    const intensity = Math.min(magnitude / 100, 1);
                    const r = Math.min(255, intensity * 255);
                    const g = Math.min(255, Math.max(0, (intensity - 0.33) * 255));
                    const b = Math.min(255, Math.max(0, (intensity - 0.66) * 255));
                    
                    spectrogramCtx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                    spectrogramCtx.fillRect(x, dataHeight - y, width / spectrogramData.length, dataHeight / timeData.length);
                }
            }
            
            // Draw labels
            spectrogramCtx.fillStyle = '#ffffff';
            spectrogramCtx.font = '12px Arial';
            spectrogramCtx.fillText('Frequency (Hz)', 10, 20);
            spectrogramCtx.fillText('Time ', width - 60, height - 10);
        }

        // Multi-Series Chart Functions
        function toggleSeries(seriesType) {
            if (!multiSeriesChart) return;
            
            const datasets = multiSeriesChart.data.datasets;
            const button = event.target;
            
            switch(seriesType) {
                case 'attitude':
                    datasets[0].hidden = !datasets[0].hidden; // Roll
                    datasets[1].hidden = !datasets[1].hidden; // Pitch
                    datasets[2].hidden = !datasets[2].hidden; // Yaw
                    break;
                case 'power':
                    datasets[3].hidden = !datasets[3].hidden; // Battery
                    break;
            }
            
            multiSeriesChart.update();
            
            // Toggle button state
            button.classList.toggle('active');
        }

        function updateMultiSeriesChart(data) {
            if (!multiSeriesChart) return;
            
            const timestamp = new Date().toLocaleTimeString();
            
            // Add new data point
            multiSeriesLabels.push(timestamp);
            multiSeriesData.attitude.roll.push(data.roll_angle || 0);
            multiSeriesData.attitude.pitch.push(data.pitch_angle || 0);
            multiSeriesData.attitude.yaw.push(data.yaw_angle || 0);
            multiSeriesData.power.voltage.push(data.battery_voltage || 0);
            
            // Keep data within limits
            if (multiSeriesLabels.length > maxMultiSeriesPoints) {
                multiSeriesLabels.shift();
                multiSeriesData.attitude.roll.shift();
                multiSeriesData.attitude.pitch.shift();
                multiSeriesData.attitude.yaw.shift();
                multiSeriesData.power.voltage.shift();
            }
            
            // Update chart
            multiSeriesChart.update('none');
        }

        function exportChartData() {
            const csvContent = [
                'Timestamp,Roll,Pitch,Yaw,Battery_Voltage',
                ...multiSeriesLabels.map((label, index) => 
                    `${label},${multiSeriesData.attitude.roll[index]},${multiSeriesData.attitude.pitch[index]},${multiSeriesData.attitude.yaw[index]},${multiSeriesData.power.voltage[index]}`
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flight_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Cesium 3D Visualization Functions
        function initializeCesiumViewer() {
            try {
                // Check if Cesium is loaded
                if (typeof Cesium === 'undefined') {
                    console.error('Cesium library not loaded');
                    document.getElementById('cesiumContainer').innerHTML = 
                        '<div style="padding: 20px; text-align: center; color: #666;">3D visualization requires Cesium library. Please check your internet connection.</div>';
                    return;
                }
                
                viewer = new Cesium.Viewer('cesiumContainer', {
                    terrainProvider: Cesium.createWorldTerrain(),
                    timeline: false,
                    animation: false,
                    homeButton: false,
                    sceneModePicker: false,
                    baseLayerPicker: false,
                    navigationHelpButton: false,
                    fullscreenButton: false,
                    vrButton: false,
                    geocoder: false,
                    infoBox: false,
                    selectionIndicator: false
                });
                
                // Set initial view to Seoul, South Korea
                viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(127.5, 37.5, 2000),
                    orientation: {
                        heading: Cesium.Math.toRadians(0),
                        pitch: Cesium.Math.toRadians(-30),
                        roll: 0.0
                    }
                });
                
                // Create aircraft entity with 3D model
                aircraftEntity = viewer.entities.add({
                    name: 'Aircraft',
                    position: Cesium.Cartesian3.fromDegrees(127.5, 37.5, 100),
                    model: {
                        uri: 'https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Assets/Models/CesiumAir/Cesium_Air.glb',
                        minimumPixelSize: 64,
                        maximumScale: 20000,
                        scale: 1.0,
                        show: true
                    },
                    label: {
                        text: 'KMU Aircraft',
                        font: '14pt sans-serif',
                        pixelOffset: new Cesium.Cartesian2(0, -50),
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        show: true
                    }
                });
                
                // Create flight path entity
                flightPathEntity = viewer.entities.add({
                    name: 'Flight Path',
                    polyline: {
                        positions: [],
                        width: 4,
                        material: Cesium.Color.YELLOW.withAlpha(0.8),
                        clampToGround: true,
                        show: true
                    }
                });
                
                // Add sample waypoints
                addSampleWaypoints();
                
                // Add sample obstacles
                addSampleObstacles();
                
                // Set up camera controls
                setupCameraControls();
                
                console.log('Cesium 3D viewer initialized successfully with aircraft model');
            } catch (error) {
                console.error('Failed to initialize Cesium viewer:', error);
                document.getElementById('cesiumContainer').innerHTML = 
                    '<div style="padding: 20px; text-align: center; color: #666;">3D visualization requires Cesium library. Please check your internet connection.<br><br>Error: ' + error.message + '</div>';
            }
        }
        
        function addSampleWaypoints() {
            const waypoints = [
                { lat: 37.5, lon: 127.5, alt: 100, name: 'Takeoff' },
                { lat: 37.51, lon: 127.51, alt: 150, name: 'Waypoint 1' },
                { lat: 37.52, lon: 127.52, alt: 200, name: 'Waypoint 2' },
                { lat: 37.53, lon: 127.53, alt: 180, name: 'Landing' }
            ];
            
            waypoints.forEach((wp, index) => {
                const waypointEntity = viewer.entities.add({
                    name: wp.name,
                    position: Cesium.Cartesian3.fromDegrees(wp.lon, wp.lat, wp.alt),
                    billboard: {
                        image: 'data:image/svg+xml;base64,' + btoa(`
                            <svg width="32" height="32" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="16" cy="16" r="12" fill="#00ff00" stroke="#ffffff" stroke-width="2"/>
                                <text x="16" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">${index + 1}</text>
                            </svg>
                        `),
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        scale: 0.8,
                        show: waypointsVisible
                    },
                    label: {
                        text: wp.name,
                        font: '12pt sans-serif',
                        pixelOffset: new Cesium.Cartesian2(0, -30),
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 1,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        show: waypointsVisible
                    }
                });
                waypointEntities.push(waypointEntity);
            });
        }
        
        function addSampleObstacles() {
            const obstacles = [
                { lat: 37.501, lon: 127.501, height: 80, name: 'Building 1' },
                { lat: 37.502, lon: 127.502, height: 120, name: 'Tower 1' },
                { lat: 37.503, lon: 127.503, height: 60, name: 'Building 2' }
            ];
            
            obstacles.forEach(obs => {
                viewer.entities.add({
                    name: obs.name,
                    position: Cesium.Cartesian3.fromDegrees(obs.lon, obs.lat, obs.height / 2),
                    box: {
                        dimensions: new Cesium.Cartesian3(20, 20, obs.height),
                        material: Cesium.Color.RED.withAlpha(0.6),
                        outline: true,
                        outlineColor: Cesium.Color.DARKRED,
                        show: obstaclesVisible
                    },
                    label: {
                        text: obs.name,
                        font: '10pt sans-serif',
                        pixelOffset: new Cesium.Cartesian2(0, -obs.height/2 - 10),
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 1,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        show: obstaclesVisible
                    }
                });
            });
        }
        
        function setupCameraControls() {
            // Add keyboard controls for camera modes
            document.addEventListener('keydown', function(event) {
                if (!viewer) return;
                
                switch(event.key) {
                    case '1':
                        setCameraMode('follow');
                        break;
                    case '2':
                        setCameraMode('free');
                        break;
                    case '3':
                        setCameraMode('cockpit');
                        break;
                    case 'r':
                    case 'R':
                        reset3DView();
                        break;
                }
            });
        }
        
        function setCameraMode(mode) {
            cameraMode = mode;
            updateCameraModeButtons();
            
            if (!aircraftEntity || !viewer) return;
            
            const position = aircraftEntity.position.getValue();
            const orientation = aircraftEntity.orientation.getValue();
            
            switch(mode) {
                case 'follow':
                    viewer.trackedEntity = aircraftEntity;
                    break;
                case 'free':
                    viewer.trackedEntity = undefined;
                    viewer.camera.lookAt(position, new Cesium.Cartesian3(0, 0, 1000));
                    break;
                case 'cockpit':
                    viewer.trackedEntity = undefined;
                    // Position camera inside aircraft
                    const cockpitPosition = Cesium.Cartesian3.add(
                        position, 
                        Cesium.Cartesian3.multiplyByScalar(
                            Cesium.Cartesian3.normalize(Cesium.Cartesian3.fromDegrees(0, 0, 1)), 
                            2, 
                            new Cesium.Cartesian3()
                        ), 
                        new Cesium.Cartesian3()
                    );
                    viewer.camera.setView({
                        destination: cockpitPosition,
                        orientation: {
                            heading: Cesium.Math.toRadians(hudData.yaw || 0),
                            pitch: Cesium.Math.toRadians(-hudData.pitch || 0),
                            roll: Cesium.Math.toRadians(hudData.roll || 0)
                        }
                    });
                    break;
            }
        }
        
        function updateCameraModeButtons() {
            // Update button states
            document.querySelectorAll('.cesium-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const modeButtons = {
                'follow': document.querySelector('[onclick="setCameraMode(\'follow\')"]'),
                'free': document.querySelector('[onclick="setCameraMode(\'free\')"]'),
                'cockpit': document.querySelector('[onclick="setCameraMode(\'cockpit\')"]')
            };
            
            if (modeButtons[cameraMode]) {
                modeButtons[cameraMode].classList.add('active');
            }
        }

        function reset3DView() {
            if (!viewer) return;
            
            viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(127.5, 37.5, 2000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-30),
                    roll: 0.0
                }
            });
            
            // Reset camera mode to follow
            setCameraMode('follow');
        }

        function toggleTerrain() {
            if (!viewer) return;
            
            terrainEnabled = !terrainEnabled;
            viewer.scene.globe.enableLighting = terrainEnabled;
            
            const button = event.target;
            button.classList.toggle('active');
            button.textContent = terrainEnabled ? 'Terrain ON' : 'Terrain OFF';
        }

        function toggleFlightPath() {
            if (!viewer || !flightPathEntity) return;
            
            flightPathVisible = !flightPathVisible;
            flightPathEntity.show = flightPathVisible;
            
            const button = event.target;
            button.classList.toggle('active');
            button.textContent = flightPathVisible ? 'Path ON' : 'Path OFF';
        }

        function toggleWaypoints() {
            if (!viewer) return;
            
            waypointsVisible = !waypointsVisible;
            waypointEntities.forEach(entity => {
                entity.billboard.show = waypointsVisible;
                entity.label.show = waypointsVisible;
            });
            
            const button = event.target;
            button.classList.toggle('active');
            button.textContent = waypointsVisible ? 'Waypoints ON' : 'Waypoints OFF';
        }

        function toggleObstacles() {
            if (!viewer) return;
            
            obstaclesVisible = !obstaclesVisible;
            
            // Update obstacle visibility
            const entities = viewer.entities.values;
            for (let i = 0; i < entities.length; i++) {
                if (entities[i].name && (entities[i].name.includes('Building') || entities[i].name.includes('Tower'))) {
                    entities[i].box.show = obstaclesVisible;
                    entities[i].label.show = obstaclesVisible;
                }
            }
            
            const button = event.target;
            button.classList.toggle('active');
            button.textContent = obstaclesVisible ? 'Obstacles ON' : 'Obstacles OFF';
        }

        function update3DFlightPath(lat, lon, alt) {
            if (!viewer || !flightPathEntity || !aircraftEntity) return;
            
            const position = Cesium.Cartesian3.fromDegrees(lon, lat, alt);
            
            // Update aircraft position
            aircraftEntity.position = position;
            
            // Update aircraft orientation based on attitude data
            if (hudData.roll !== undefined && hudData.pitch !== undefined && hudData.yaw !== undefined) {
                const heading = Cesium.Math.toRadians(hudData.yaw);
                const pitch = Cesium.Math.toRadians(hudData.pitch);
                const roll = Cesium.Math.toRadians(hudData.roll);
                
                aircraftEntity.orientation = Cesium.Transforms.headingPitchRollQuaternion(
                    position,
                    new Cesium.HeadingPitchRoll(heading, pitch, roll)
                );
            }
            
            // Add position to flight path
            const positions = flightPathEntity.polyline.positions.getValue();
            positions.push(position);
            
            // Keep only recent positions (last 200 points for better performance)
            if (positions.length > 200) {
                positions.shift();
            }
            
            // Update flight path
            flightPathEntity.polyline.positions = positions;
            
            // Update aircraft label with current data
            aircraftEntity.label.text = `KMU Aircraft\nAlt: ${alt.toFixed(1)}m\nRoll: ${(hudData.roll || 0).toFixed(1)}\nPitch: ${(hudData.pitch || 0).toFixed(1)}`;
            
            // Update camera based on mode
            updateCameraForMode(position);
        }
        
        function updateCameraForMode(position) {
            if (!viewer) return;
            
            switch(cameraMode) {
                case 'follow':
                    // Camera follows aircraft automatically when tracked
                    break;
                case 'free':
                    // Keep current camera position
                    break;
                case 'cockpit':
                    // Update cockpit view with current attitude
                    const cockpitPosition = Cesium.Cartesian3.add(
                        position, 
                        Cesium.Cartesian3.multiplyByScalar(
                            Cesium.Cartesian3.normalize(Cesium.Cartesian3.fromDegrees(0, 0, 1)), 
                            2, 
                            new Cesium.Cartesian3()
                        ), 
                        new Cesium.Cartesian3()
                    );
                    viewer.camera.setView({
                        destination: cockpitPosition,
                        orientation: {
                            heading: Cesium.Math.toRadians(hudData.yaw || 0),
                            pitch: Cesium.Math.toRadians(-hudData.pitch || 0),
                            roll: Cesium.Math.toRadians(hudData.roll || 0)
                        }
                    });
                    break;
            }
        }

        // Log Analysis Functions
        function initializeLogAnalysisChart() {
            const logAnalysisCtx = document.getElementById('logAnalysisChart').getContext('2d');
            logAnalysisChart = new Chart(logAnalysisCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        function loadLogFiles() {
            const fileInput = document.getElementById('logFileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Please select log files to analyze');
                return;
            }
            
            loadedLogFiles = [];
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const logData = parseLogFile(content, file.name);
                    loadedLogFiles.push({
                        name: file.name,
                        data: logData
                    });
                };
                reader.readAsText(file);
            });
            
            setTimeout(() => {
                console.log(`Loaded ${loadedLogFiles.length} log files`);
            }, 1000);
        }

        function parseLogFile(content, filename) {
            const lines = content.split('\n');
            const data = [];
            
            lines.forEach((line, index) => {
                if (line.trim() === '' || line.startsWith('#')) return;
                
                const parts = line.split(',');
                if (parts.length >= 4) {
                    data.push({
                        timestamp: parts[0],
                        roll: parseFloat(parts[1]) || 0,
                        pitch: parseFloat(parts[2]) || 0,
                        yaw: parseFloat(parts[3]) || 0,
                        altitude: parseFloat(parts[4]) || 0
                    });
                }
            });
            
            return data;
        }

        function analyzeLogData() {
            if (loadedLogFiles.length === 0) {
                alert('Please load log files first');
                return;
            }
            
            // Combine all log data
            const allData = [];
            loadedLogFiles.forEach(file => {
                allData.push(...file.data);
            });
            
            // Sort by timestamp
            allData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // Update chart
            const labels = allData.map(d => d.timestamp);
            const rollData = allData.map(d => d.roll);
            const pitchData = allData.map(d => d.pitch);
            const yawData = allData.map(d => d.yaw);
            const altData = allData.map(d => d.altitude);
            
            logAnalysisChart.data = {
                labels: labels,
                datasets: [
                    {
                        label: 'Roll',
                        data: rollData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    },
                    {
                        label: 'Pitch',
                        data: pitchData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1
                    },
                    {
                        label: 'Yaw',
                        data: yawData,
                        borderColor: 'rgb(255, 205, 86)',
                        backgroundColor: 'rgba(255, 205, 86, 0.2)',
                        tension: 0.1
                    },
                    {
                        label: 'Altitude',
                        data: altData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }
                ]
            };
            
            logAnalysisChart.update();
            
            // Calculate statistics
            calculateAnalysisStats(allData);
        }

        function calculateAnalysisStats(data) {
            const stats = {
                totalPoints: data.length,
                duration: 0,
                maxRoll: Math.max(...data.map(d => d.roll)),
                minRoll: Math.min(...data.map(d => d.roll)),
                maxPitch: Math.max(...data.map(d => d.pitch)),
                minPitch: Math.min(...data.map(d => d.pitch)),
                maxAltitude: Math.max(...data.map(d => d.altitude)),
                minAltitude: Math.min(...data.map(d => d.altitude))
            };
            
            if (data.length > 1) {
                const startTime = new Date(data[0].timestamp);
                const endTime = new Date(data[data.length - 1].timestamp);
                stats.duration = (endTime - startTime) / 1000; // seconds
            }
            
            // Display statistics
            const statsDiv = document.getElementById('analysisStats');
            statsDiv.innerHTML = `
                <div class="stat-item">
                    <strong>Total Data Points:</strong> ${stats.totalPoints}
                </div>
                <div class="stat-item">
                    <strong>Duration:</strong> ${stats.duration.toFixed(1)} seconds
                </div>
                <div class="stat-item">
                    <strong>Roll Range:</strong> ${stats.minRoll.toFixed(2)} to ${stats.maxRoll.toFixed(2)}
                </div>
                <div class="stat-item">
                    <strong>Pitch Range:</strong> ${stats.minPitch.toFixed(2)} to ${stats.maxPitch.toFixed(2)}
                </div>
                <div class="stat-item">
                    <strong>Altitude Range:</strong> ${stats.minAltitude.toFixed(1)}m to ${stats.maxAltitude.toFixed(1)}m
                </div>
            `;
            
            analysisResults = stats;
        }

        function exportAnalysis() {
            if (!analysisResults || Object.keys(analysisResults).length === 0) {
                alert('Please analyze data first');
                return;
            }
            
            const analysisText = `
Flight Data Analysis Report
Generated: ${new Date().toISOString()}

Statistics:
- Total Data Points: ${analysisResults.totalPoints}
- Duration: ${analysisResults.duration.toFixed(1)} seconds
- Roll Range: ${analysisResults.minRoll.toFixed(2)} to ${analysisResults.maxRoll.toFixed(2)}
- Pitch Range: ${analysisResults.minPitch.toFixed(2)} to ${analysisResults.maxPitch.toFixed(2)}
- Altitude Range: ${analysisResults.minAltitude.toFixed(1)}m to ${analysisResults.maxAltitude.toFixed(1)}m

Files Analyzed: ${loadedLogFiles.map(f => f.name).join(', ')}
            `;
            
            const blob = new Blob([analysisText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flight_analysis_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // ===== TELEMETRY DASHBOARD IMPLEMENTATION =====
        
        // Telemetry tracking variables
        let telemetryStats = {
            totalMessages: 0,
            messagesPerSecond: 0,
            dataLoss: 0,
            startTime: Date.now(),
            lastSecondTime: Date.now(),
            messagesThisSecond: 0,
            expectedMessages: 0,
            ahrsRate: 0,
            gpsRate: 0,
            powerRate: 0,
            connectionQuality: 0
        };
        
        let telemetryCharts = {
            telemetryChart: null,
            dataRateChart: null,
            messageDistributionChart: null
        };
        
        let telemetryData = {
            labels: [],
            ahrsRate: [],
            gpsRate: [],
            powerRate: [],
            connectionQuality: []
        };
        
        let messageCounts = {
            ahrs: 0,
            gps: 0,
            power: 0,
            other: 0
        };
        
        let alertsEnabled = true;
        
        // Initialize telemetry dashboard
        function initializeTelemetryDashboard() {
            console.log('Initializing telemetry dashboard...');
            
            // Initialize charts
            initializeTelemetryCharts();
            
            // Start telemetry monitoring
            startTelemetryMonitoring();
            
            // Update UI every second
            setInterval(updateTelemetryUI, 1000);
            
            console.log('Telemetry dashboard initialized');
        }
        
        function initializeTelemetryCharts() {
            // Real-time telemetry chart
            const telemetryCtx = document.getElementById('telemetryChart');
            if (telemetryCtx) {
                telemetryCharts.telemetryChart = new Chart(telemetryCtx, {
                    type: 'line',
                    data: {
                        labels: telemetryData.labels,
                        datasets: [
                            {
                                label: 'AHRS Rate (Hz)',
                                data: telemetryData.ahrsRate,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'GPS Rate (Hz)',
                                data: telemetryData.gpsRate,
                                borderColor: '#2ecc71',
                                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Power Rate (Hz)',
                                data: telemetryData.powerRate,
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Connection Quality (%)',
                                data: telemetryData.connectionQuality,
                                borderColor: '#f39c12',
                                backgroundColor: 'rgba(243, 156, 18, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 60,
                                title: {
                                    display: true,
                                    text: 'Data Rate (Hz) / Quality (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'Real-time Telemetry Data Rates'
                            }
                        },
                        animation: {
                            duration: 0
                        }
                    }
                });
            }
            
            // Data rate analysis chart
            const dataRateCtx = document.getElementById('dataRateChart');
            if (dataRateCtx) {
                telemetryCharts.dataRateChart = new Chart(dataRateCtx, {
                    type: 'bar',
                    data: {
                        labels: ['AHRS', 'GPS', 'Power', 'Other'],
                        datasets: [{
                            label: 'Messages/sec',
                            data: [0, 0, 0, 0],
                            backgroundColor: [
                                '#3498db',
                                '#2ecc71',
                                '#e74c3c',
                                '#9b59b6'
                            ],
                            borderColor: [
                                '#2980b9',
                                '#27ae60',
                                '#c0392b',
                                '#8e44ad'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Messages per Second'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Message Rate Analysis'
                            }
                        }
                    }
                });
            }
            
            // Message distribution chart
            const messageDistCtx = document.getElementById('messageDistributionChart');
            if (messageDistCtx) {
                telemetryCharts.messageDistributionChart = new Chart(messageDistCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['AHRS', 'GPS', 'Power', 'Other'],
                        datasets: [{
                            data: [0, 0, 0, 0],
                            backgroundColor: [
                                '#3498db',
                                '#2ecc71',
                                '#e74c3c',
                                '#9b59b6'
                            ],
                            borderColor: [
                                '#2980b9',
                                '#27ae60',
                                '#c0392b',
                                '#8e44ad'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Message Distribution'
                            }
                        }
                    }
                });
            }
        }
        
        function startTelemetryMonitoring() {
            // Monitor data rates every second
            setInterval(() => {
                const now = Date.now();
                const timeDiff = (now - telemetryStats.lastSecondTime) / 1000;
                
                if (timeDiff >= 1.0) {
                    // Calculate messages per second
                    telemetryStats.messagesPerSecond = telemetryStats.messagesThisSecond / timeDiff;
                    
                    // Reset counters
                    telemetryStats.messagesThisSecond = 0;
                    telemetryStats.lastSecondTime = now;
                    
                    // Update charts
                    updateTelemetryCharts();
                    
                    // Check for alerts
                    checkTelemetryAlerts();
                }
            }, 100);
        }
        
        function updateTelemetryStats(messageType) {
            telemetryStats.totalMessages++;
            telemetryStats.messagesThisSecond++;
            
            // Count message types
            if (messageType === 'ahrs') {
                messageCounts.ahrs++;
                telemetryStats.ahrsRate = calculateDataRate('ahrs');
            } else if (messageType === 'gps') {
                messageCounts.gps++;
                telemetryStats.gpsRate = calculateDataRate('gps');
            } else if (messageType === 'power') {
                messageCounts.power++;
                telemetryStats.powerRate = calculateDataRate('power');
            } else {
                messageCounts.other++;
            }
            
            // Calculate connection quality
            telemetryStats.connectionQuality = calculateConnectionQuality();
        }
        
        function calculateDataRate(messageType) {
            // Use real data rates from backend system status
            // This will be updated by updateSystemStatus() function
            return telemetryStats[messageType + 'Rate'] || 0;
        }
        
        function calculateConnectionQuality() {
            // Calculate based on actual data rates from backend
            const expectedTotal = 65; // 50 + 10 + 5
            const actualTotal = telemetryStats.ahrsRate + telemetryStats.gpsRate + telemetryStats.powerRate;
            
            return Math.min(100, Math.max(0, (actualTotal / expectedTotal) * 100));
        }
        
        function updateTelemetryCharts() {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            
            // Add new data point
            telemetryData.labels.push(timeLabel);
            telemetryData.ahrsRate.push(telemetryStats.ahrsRate);
            telemetryData.gpsRate.push(telemetryStats.gpsRate);
            telemetryData.powerRate.push(telemetryStats.powerRate);
            telemetryData.connectionQuality.push(telemetryStats.connectionQuality);
            
            // Keep only last 60 data points (1 minute)
            if (telemetryData.labels.length > 60) {
                telemetryData.labels.shift();
                telemetryData.ahrsRate.shift();
                telemetryData.gpsRate.shift();
                telemetryData.powerRate.shift();
                telemetryData.connectionQuality.shift();
            }
            
            // Update charts
            if (telemetryCharts.telemetryChart) {
                telemetryCharts.telemetryChart.update('none');
            }
            
            if (telemetryCharts.dataRateChart) {
                telemetryCharts.dataRateChart.data.datasets[0].data = [
                    messageCounts.ahrs,
                    messageCounts.gps,
                    messageCounts.power,
                    messageCounts.other
                ];
                telemetryCharts.dataRateChart.update('none');
            }
            
            if (telemetryCharts.messageDistributionChart) {
                const total = messageCounts.ahrs + messageCounts.gps + messageCounts.power + messageCounts.other;
                if (total > 0) {
                    telemetryCharts.messageDistributionChart.data.datasets[0].data = [
                        messageCounts.ahrs,
                        messageCounts.gps,
                        messageCounts.power,
                        messageCounts.other
                    ];
                    telemetryCharts.messageDistributionChart.update('none');
                }
            }
        }
        
        function updateTelemetryUI() {
            // Update data rate cards
            updateDataRateCard('ahrsRate', telemetryStats.ahrsRate, 'AHRS');
            updateDataRateCard('gpsRate', telemetryStats.gpsRate, 'GPS');
            updateDataRateCard('powerRate', telemetryStats.powerRate, 'Power');
            updateDataRateCard('connectionQuality', telemetryStats.connectionQuality, 'Connection');
            
            // Update statistics
            document.getElementById('totalMessages').textContent = telemetryStats.totalMessages.toLocaleString();
            document.getElementById('messagesPerSecond').textContent = telemetryStats.messagesPerSecond.toFixed(1);
            document.getElementById('dataLoss').textContent = telemetryStats.dataLoss.toFixed(1) + '%';
            
            // Update uptime
            const uptime = Date.now() - telemetryStats.startTime;
            const hours = Math.floor(uptime / 3600000);
            const minutes = Math.floor((uptime % 3600000) / 60000);
            const seconds = Math.floor((uptime % 60000) / 1000);
            document.getElementById('uptime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function updateDataRateCard(elementId, value, type) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const card = element.closest('.telemetry-card');
            if (!card) return;
            
            // Update value
            if (type === 'Connection') {
                element.textContent = value.toFixed(1) + '%';
            } else {
                element.textContent = value.toFixed(1) + ' Hz';
            }
            
            // Update status and color
            let status = '';
            let statusClass = '';
            
            if (type === 'Connection') {
                if (value >= 90) {
                    status = 'Excellent';
                    statusClass = 'good';
                } else if (value >= 70) {
                    status = 'Good';
                    statusClass = 'good';
                } else if (value >= 50) {
                    status = 'Fair';
                    statusClass = 'warning';
                } else {
                    status = 'Poor';
                    statusClass = 'critical';
                }
            } else {
                const expectedRates = { AHRS: 50, GPS: 10, Power: 5 };
                const expected = expectedRates[type] || 0;
                
                if (value >= expected * 0.9) {
                    status = 'Good';
                    statusClass = 'good';
                } else if (value >= expected * 0.5) {
                    status = 'Low';
                    statusClass = 'warning';
                } else if (value > 0) {
                    status = 'Critical';
                    statusClass = 'critical';
                } else {
                    status = 'Disconnected';
                    statusClass = 'disconnected';
                }
            }
            
            // Update status text
            const statusElement = card.querySelector('.card-status');
            if (statusElement) {
                statusElement.textContent = status;
            }
            
            // Update card color
            card.className = `telemetry-card ${statusClass}`;
        }
        
        function checkTelemetryAlerts() {
            if (!alertsEnabled) return;
            
            // Check for low data rates
            if (telemetryStats.ahrsRate < 25 && telemetryStats.ahrsRate > 0) {
                showTelemetryAlert('AHRS data rate is low: ' + telemetryStats.ahrsRate.toFixed(1) + ' Hz', 'warning');
            }
            
            if (telemetryStats.gpsRate < 5 && telemetryStats.gpsRate > 0) {
                showTelemetryAlert('GPS data rate is low: ' + telemetryStats.gpsRate.toFixed(1) + ' Hz', 'warning');
            }
            
            if (telemetryStats.connectionQuality < 50) {
                showTelemetryAlert('Connection quality is poor: ' + telemetryStats.connectionQuality.toFixed(1) + '%', 'critical');
            }
        }
        
        function showTelemetryAlert(message, type) {
            // Create alert notification
            const alert = document.createElement('div');
            alert.className = `telemetry-alert ${type}`;
            alert.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()"></button>
            `;
            
            // Add to page
            document.body.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // Telemetry control functions
        function resetTelemetryStats() {
            telemetryStats = {
                totalMessages: 0,
                messagesPerSecond: 0,
                dataLoss: 0,
                startTime: Date.now(),
                lastSecondTime: Date.now(),
                messagesThisSecond: 0,
                expectedMessages: 0,
                ahrsRate: 0,
                gpsRate: 0,
                powerRate: 0,
                connectionQuality: 0
            };
            
            messageCounts = {
                ahrs: 0,
                gps: 0,
                power: 0,
                other: 0
            };
            
            telemetryData = {
                labels: [],
                ahrsRate: [],
                gpsRate: [],
                powerRate: [],
                connectionQuality: []
            };
            
            // Reset charts
            if (telemetryCharts.telemetryChart) {
                telemetryCharts.telemetryChart.update();
            }
            if (telemetryCharts.dataRateChart) {
                telemetryCharts.dataRateChart.update();
            }
            if (telemetryCharts.messageDistributionChart) {
                telemetryCharts.messageDistributionChart.update();
            }
            
            updateTelemetryUI();
            console.log('Telemetry statistics reset');
        }
        
        function exportTelemetryData() {
            const data = {
                stats: telemetryStats,
                messageCounts: messageCounts,
                chartData: telemetryData,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `telemetry_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function toggleTelemetryAlerts() {
            alertsEnabled = !alertsEnabled;
            const button = event.target;
            button.textContent = alertsEnabled ? 
                '<i class="fas fa-bell"></i> Alerts ON' : 
                '<i class="fas fa-bell-slash"></i> Alerts OFF';
            button.classList.toggle('active');
        }
        
        // Enhanced data update function to feed telemetry
        function updateTelemetryFromData(data) {
            // Determine message type and update stats
            if (data.roll_angle !== undefined || data.pitch_angle !== undefined) {
                updateTelemetryStats('ahrs');
            }
            if (data.latitude !== undefined || data.longitude !== undefined) {
                updateTelemetryStats('gps');
            }
            if (data.battery_voltage !== undefined) {
                updateTelemetryStats('power');
            }
        }

        // Enhanced data update function to feed advanced visualizations
        function updateAdvancedVisualizations(data) {
            // Update multi-series chart
            updateMultiSeriesChart(data);
            
            // Update 3D flight path if GPS data available
            if (data.latitude && data.longitude) {
                update3DFlightPath(data.latitude, data.longitude, data.altitude || 0);
            }
        }

        // Initialize advanced features when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize advanced charts after a short delay to ensure all elements are loaded
            setTimeout(() => {
                initializeAdvancedCharts();
                initializeProfessionalHUD();
                initializeCesiumViewer();
                initializeLogAnalysisChart();
                initializeTelemetryDashboard();
            }, 1000);
        });
    </script>
</body>
</html>
